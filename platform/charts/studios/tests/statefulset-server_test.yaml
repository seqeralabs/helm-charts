# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Studios server statefulset
templates:
- statefulset-server.yaml
- secret.yaml
tests:
- it: should set the statefulset server image using the chart version and use sane defaults
  template: statefulset-server.yaml
  chart:
    version: 8.7.6+test
    appVersion: 9.9.9
  set:
    proxy:
      oidcClientRegistrationToken: my-oidc-token
  asserts:
  - isKind:
      of: StatefulSet
  - equal:
      path: metadata.name
      value: release-name-studios-server
  - matchSnapshot: {}
- it: should render the server deployment with the specified tag version
  template: statefulset-server.yaml
  set:
    server:
      image:
        tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/data-studio/connect-server:1.2.3
- it: should render the server deployment with the specified digest
  template: statefulset-server.yaml
  set:
    server:
      image:
        digest: sha256:1234abcdef
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/data-studio/connect-server@sha256:1234abcdef
- it: should render the server deployment with the correct checksums
  template: statefulset-server.yaml
  chart:
    version: 8.7.6+test
    appVersion: 9.9.9
  set:
    proxy:
      oidcClientRegistrationToken: asdf
    server:
      podLabels:
        key123: this-overrides-the-commonLabels
    redis:
      password: fdsa
    commonLabels:
      key123: this-should-be-overridden
      key456: this-should-not-be-overridden
  asserts:
  - equal:
      path: spec.template.metadata.annotations
      value:
        checksum/secret: 07f59012286ce98a15a3872ddd71f50df6a93068fb9cd958e16d11a44e40e856
  - equal:
      path: spec.template.metadata.labels
      value:
        app.kubernetes.io/component: server
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: studios
        app.kubernetes.io/version: 9.9.9
        helm.sh/chart: studios-8.7.6_test
        key123: this-overrides-the-commonLabels
        key456: this-should-not-be-overridden
- it: should run using config requested by the user
  template: statefulset-server.yaml
  chart:
    version: 8.7.6+test
    appVersion: 9.9.9
  set:
    proxy:
      oidcClientRegistrationToken: my-oidc-token
    server:
      image:
        pullPolicy: Always
        pullSecrets:
        - aCustomImageRepositorySecretName
      command:
      - customCommand
      args:
      - arg0
      - arg1
      extraEnvVars:
      - name: MY_SPECIAL_ENVIRONMENT_VARIABLE
        value: set-a-value-here
      extraEnvVarsCM: CMContainingExtraEnvVars
      extraEnvVarsSecret: SecretContainingExtraEnvVars
      extraVolumes:
      - name: extraVolumeName
        emptyDir:
          sizeLimit: 1Mi
      extraVolumeMounts:
      - mountPath: /mymntpoint
        name: extraVolumeName
      podSecurityContext:
        enabled: true
        fsGroup: 9999
      containerSecurityContext:
        enabled: true
        runAsUser: 9998
        runAsGroup: 9999
        runAsNonRoot: true
        readOnlyRootFilesystem: true
        capabilities:
          drop: []
          add:
          - NET_BIND_SERVICE
          - NET_ADMIN
    serviceAccount:
      name: user-provided-sa
  asserts:
  - matchSnapshot:
      path: spec
- it: should not enable redis auth unless it is enabled
  template: statefulset-server.yaml
  set:
    redis:
      password: ''
      existingSecretName: ''
  asserts:
  - equal:
      path: spec.template.spec.containers[0].env
      value: null
  - lengthEqual:
      path: spec.template.spec.containers[0].envFrom
      count: 2
- it: should render resources when specified
  template: statefulset-server.yaml
  set:
    server:
      resources:
        requests:
          cpu: 250m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 1Gi
  asserts:
  - equal:
      path: spec.template.spec.containers[0].resources
      value:
        requests:
          cpu: 250m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 1Gi
- it: should render resources with only limits
  template: statefulset-server.yaml
  set:
    server:
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
  asserts:
  - equal:
      path: spec.template.spec.containers[0].resources
      value:
        limits:
          cpu: 500m
          memory: 512Mi
- it: should render init containers when specified
  template: statefulset-server.yaml
  set:
    server:
      initContainers:
      - name: init-wait
        image: busybox:1.28
        command:
        - sh
        - -c
        - echo waiting for dependencies
  asserts:
  - lengthEqual:
      path: spec.template.spec.initContainers
      count: 1
  - equal:
      path: spec.template.spec.initContainers[0].name
      value: init-wait
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: busybox:1.28
- it: should apply extraOptionsSpec at StatefulSet spec level
  template: statefulset-server.yaml
  set:
    server:
      extraOptionsSpec:
        replicas: 3
        updateStrategy:
          type: RollingUpdate
          rollingUpdate:
            partition: 1
        podManagementPolicy: Parallel
  asserts:
  - equal:
      path: spec.replicas
      value: 3
  - equal:
      path: spec.updateStrategy.type
      value: RollingUpdate
  - equal:
      path: spec.updateStrategy.rollingUpdate.partition
      value: 1
  - equal:
      path: spec.podManagementPolicy
      value: Parallel
- it: should not override selector or serviceName with extraOptionsSpec
  template: statefulset-server.yaml
  set:
    server:
      extraOptionsSpec:
        selector:
          matchLabels:
            should: not-appear
        serviceName: should-not-appear
        replicas: 2
  asserts:
  - equal:
      path: spec.replicas
      value: 2
  - notEqual:
      path: spec.serviceName
      value: should-not-appear
  - equal:
      path: spec.serviceName
      value: release-name-studios-server
  - notEqual:
      path: spec.selector.matchLabels.should
      value: not-appear
- it: should apply affinity with extraOptionsTemplateSpec
  template: statefulset-server.yaml
  set:
    server:
      extraOptionsTemplateSpec:
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                  - amd64
  asserts:
  - exists:
      path: spec.template.spec.affinity.nodeAffinity
  - equal:
      path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
      value: kubernetes.io/arch
- it: should render custom pod annotations
  template: statefulset-server.yaml
  set:
    server:
      podAnnotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        custom-annotation: custom-value
  asserts:
  - equal:
      path: spec.template.metadata.annotations["prometheus.io/scrape"]
      value: 'true'
  - equal:
      path: spec.template.metadata.annotations["prometheus.io/port"]
      value: '9090'
  - equal:
      path: spec.template.metadata.annotations["custom-annotation"]
      value: custom-value
  - exists:
      path: spec.template.metadata.annotations["checksum/secret"]
- it: should not render pod security context when disabled
  template: statefulset-server.yaml
  set:
    server:
      podSecurityContext:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should enable redis auth when password is set
  template: statefulset-server.yaml
  set:
    redis:
      password: my-secret-password
  asserts:
  - lengthEqual:
      path: spec.template.spec.containers[0].env
      count: 1
  - equal:
      path: spec.template.spec.containers[0].env[0]
      value:
        name: CONNECT_REDIS_PASSWORD
        valueFrom:
          secretKeyRef:
            name: release-name-studios
            key: CONNECT_REDIS_PASSWORD
  - lengthEqual:
      path: spec.template.spec.containers[0].envFrom
      count: 2
- it: should enable redis auth when existingSecretName is set
  template: statefulset-server.yaml
  set:
    redis:
      existingSecretName: external-redis-secret
  asserts:
  - lengthEqual:
      path: spec.template.spec.containers[0].env
      count: 1
  - equal:
      path: spec.template.spec.containers[0].env[0]
      value:
        name: CONNECT_REDIS_PASSWORD
        valueFrom:
          secretKeyRef:
            name: external-redis-secret
            key: CONNECT_REDIS_PASSWORD
  - lengthEqual:
      path: spec.template.spec.containers[0].envFrom
      count: 2
- it: should use custom existingSecretKey when both existingSecretName and existingSecretKey are set
  template: statefulset-server.yaml
  set:
    redis:
      existingSecretName: external-redis-secret
      existingSecretKey: MY_CUSTOM_KEY
  asserts:
  - lengthEqual:
      path: spec.template.spec.containers[0].env
      count: 1
  - equal:
      path: spec.template.spec.containers[0].env[0]
      value:
        name: CONNECT_REDIS_PASSWORD
        valueFrom:
          secretKeyRef:
            name: external-redis-secret
            key: MY_CUSTOM_KEY
- it: should apply commonAnnotations to statefulset metadata
  template: statefulset-server.yaml
  set:
    commonAnnotations:
      example.com/annotation: value1
      another.com/annotation: value2
  asserts:
  - equal:
      path: metadata.annotations
      value:
        example.com/annotation: value1
        another.com/annotation: value2
- it: should evaluate template expressions in commonAnnotations
  template: statefulset-server.yaml
  release:
    name: my-release
  set:
    commonAnnotations:
      release-annotation: '{{ .Release.Name }}-annotation'
      chart-annotation: '{{ .Chart.Name }}'
  asserts:
  - equal:
      path: metadata.annotations
      value:
        release-annotation: my-release-annotation
        chart-annotation: studios
- it: should not render annotations when commonAnnotations is empty
  template: statefulset-server.yaml
  set:
    commonAnnotations: {}
  asserts:
  - notExists:
      path: metadata.annotations
- it: should handle empty extraEnvVars array gracefully without redis auth
  template: statefulset-server.yaml
  set:
    redis:
      password: ''
      existingSecretName: ''
    server:
      extraEnvVars: []
  asserts:
  - equal:
      path: spec.template.spec.containers[0].env
      value: null
- it: should include component label in statefulset metadata
  template: statefulset-server.yaml
  asserts:
  - equal:
      path: metadata.labels["app.kubernetes.io/component"]
      value: server
- it: should render podAnnotations as-is without template evaluation
  template: statefulset-server.yaml
  release:
    name: my-release
  set:
    server:
      podAnnotations:
        static-annotation: my-value
        example-template: '{{ .Release.Name }}-annotation'
  asserts:
  - equal:
      path: spec.template.metadata.annotations["static-annotation"]
      value: my-value
  - equal:
      path: spec.template.metadata.annotations["example-template"]
      value: '{{ .Release.Name }}-annotation'
- it: should render all envFrom sources in correct order without redis auth
  template: statefulset-server.yaml
  set:
    redis:
      password: ''
  asserts:
  - lengthEqual:
      path: spec.template.spec.containers[0].envFrom
      count: 2
  - equal:
      path: spec.template.spec.containers[0].envFrom[0]
      value:
        configMapRef:
          name: release-name-studios-common
  - equal:
      path: spec.template.spec.containers[0].envFrom[1]
      value:
        configMapRef:
          name: release-name-studios-server
- it: should render multiple extraEnvVarsCM and extraEnvVarsSecret in correct order
  template: statefulset-server.yaml
  set:
    redis:
      password: my-password
    server:
      extraEnvVarsCM: extra-cm
      extraEnvVarsSecret: extra-secret
  asserts:
  - lengthEqual:
      path: spec.template.spec.containers[0].envFrom
      count: 4
  - equal:
      path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
      value: release-name-studios-common
  - equal:
      path: spec.template.spec.containers[0].envFrom[1].configMapRef.name
      value: release-name-studios-server
  - equal:
      path: spec.template.spec.containers[0].envFrom[2].configMapRef.name
      value: extra-cm
  - equal:
      path: spec.template.spec.containers[0].envFrom[3].secretRef.name
      value: extra-secret
  - lengthEqual:
      path: spec.template.spec.containers[0].env
      count: 1
  - equal:
      path: spec.template.spec.containers[0].env[0].name
      value: CONNECT_REDIS_PASSWORD
- it: should include configMapRef for studios-common
  template: statefulset-server.yaml
  asserts:
  - contains:
      path: spec.template.spec.containers[0].envFrom
      content:
        configMapRef:
          name: release-name-studios-common
- it: should include configMapRef for studios-server
  template: statefulset-server.yaml
  asserts:
  - contains:
      path: spec.template.spec.containers[0].envFrom
      content:
        configMapRef:
          name: release-name-studios-server
- it: should render image with registry and digest
  template: statefulset-server.yaml
  set:
    server:
      image:
        registry: my-registry.example.com
        digest: sha256:abcd1234
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-registry.example.com/private/nf-tower-enterprise/data-studio/connect-server@sha256:abcd1234
- it: should render container with correct imagePullPolicy
  template: statefulset-server.yaml
  set:
    server:
      image:
        pullPolicy: Always
  asserts:
  - equal:
      path: spec.template.spec.containers[0].imagePullPolicy
      value: Always
- it: should not render imagePullSecrets when empty
  template: statefulset-server.yaml
  set:
    server:
      image:
        pullSecrets: []
  asserts:
  - equal:
      path: spec.template.spec.imagePullSecrets
      value: null
- it: should omit the enabled field from podSecurityContext
  template: statefulset-server.yaml
  set:
    server:
      podSecurityContext:
        enabled: true
        fsGroup: 1000
        runAsNonRoot: true
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 1000
        runAsNonRoot: true
- it: should not render container security context when disabled
  template: statefulset-server.yaml
  set:
    server:
      containerSecurityContext:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.containers[0].securityContext
- it: should render default podSecurityContext
  template: statefulset-server.yaml
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 65532
- it: should render persistentVolumeClaimRetentionPolicy in extraOptionsSpec
  template: statefulset-server.yaml
  set:
    server:
      extraOptionsSpec:
        persistentVolumeClaimRetentionPolicy:
          whenDeleted: Retain
          whenScaled: Delete
  asserts:
  - equal:
      path: spec.persistentVolumeClaimRetentionPolicy
      value:
        whenDeleted: Retain
        whenScaled: Delete
