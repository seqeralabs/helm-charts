# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Studios proxy deployment
templates:
- deployment-proxy.yaml
- secret.yaml
tests:
- it: should set the proxy deployment image using the chart version and use sane defaults
  template: deployment-proxy.yaml
  chart:
    version: 9.9.9+test
    appVersion: 9.9.9
  set:
    global:
      platformServiceAddress: platform-backend
      platformServicePort: 8080
    proxy:
      oidcClientRegistrationToken: my-oidc-token
  asserts:
  - isKind:
      of: Deployment
  - equal:
      path: metadata.name
      value: release-name-studios-proxy
  - matchSnapshot: {}
- it: should render the proxy deployment with the specified tag version
  template: deployment-proxy.yaml
  set:
    proxy:
      image:
        tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/data-studio/connect-proxy:1.2.3
- it: should render the proxy deployment with the specified digest
  template: deployment-proxy.yaml
  set:
    proxy:
      image:
        digest: sha256:1234abcdef
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/data-studio/connect-proxy@sha256:1234abcdef
- it: should render the proxy deployment with the correct checksums
  template: deployment-proxy.yaml
  chart:
    version: 9.9.9+test
    appVersion: 9.9.9
  set:
    proxy:
      oidcClientRegistrationToken: asdf
      podLabels:
        key123: this-overrides-the-commonLabels
    redis:
      password: fdsa
    commonLabels:
      key123: this-should-be-overridden
      key456: this-should-not-be-overridden
  asserts:
  - equal:
      path: spec.template.metadata.annotations
      value:
        checksum/secret: d5b47d6acae424280cfbd1dc8df12b36612aff6d949782e03dc58d0458c775e8
  - equal:
      path: spec.template.metadata.labels
      value:
        app.kubernetes.io/component: proxy
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: studios
        app.kubernetes.io/version: 9.9.9
        helm.sh/chart: studios-9.9.9_test
        key123: this-overrides-the-commonLabels
        key456: this-should-not-be-overridden
- it: should run using config requested by the user
  template: deployment-proxy.yaml
  chart:
    version: 9.9.9+test
    appVersion: 9.9.9
  set:
    global:
      platformServiceAddress: platform-backend
      platformServicePort: 8080
    proxy:
      oidcClientRegistrationToken: my-oidc-token
      image:
        pullPolicy: Always
        pullSecrets:
        - aCustomImageRepositorySecretName
      command:
      - customCommand
      args:
      - arg0
      - arg1
      extraEnvVars:
      - name: MY_SPECIAL_ENVIRONMENT_VARIABLE
        value: set-a-value-here
      extraEnvVarsCMs:
      - CMContainingExtraEnvVars
      extraEnvVarsSecrets:
      - SecretContainingExtraEnvVars
      extraVolumes:
      - name: extraVolumeName
        emptyDir:
          sizeLimit: 1Mi
      extraVolumeMounts:
      - mountPath: /mymntpoint
        name: extraVolumeName
      podSecurityContext:
        enabled: true
        fsGroup: 9999
      containerSecurityContext:
        enabled: true
        runAsUser: 9998
        runAsGroup: 9999
        runAsNonRoot: true
        readOnlyRootFilesystem: true
        capabilities:
          drop: []
          add:
          - NET_BIND_SERVICE
          - NET_ADMIN
    serviceAccount:
      name: user-provided-sa
  asserts:
  - matchSnapshot:
      path: spec
- it: should not enable redis auth unless it is enabled
  template: deployment-proxy.yaml
  set:
    redis:
      auth:
        enabled: false
        password: this should not get set
  asserts:
  - lengthEqual:
      path: spec.template.spec.containers[0].envFrom
      count: 2
  - notContains:
      path: spec.template.spec.containers[0].envFrom
      content:
        secretRef:
          name: release-name-studios-redis-password
- it: should include component label in deployment metadata
  template: deployment-proxy.yaml
  chart:
    version: 9.8.7
    appVersion: v1.2.3
  asserts:
  - isSubset:
      path: metadata.labels
      content:
        app.kubernetes.io/component: proxy
- it: should apply commonLabels to deployment metadata
  template: deployment-proxy.yaml
  chart:
    version: 9.8.7
    appVersion: v1.2.3
  set:
    commonLabels:
      environment: production
      team: platform
  asserts:
  - equal:
      path: metadata.labels
      value:
        app.kubernetes.io/component: proxy
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: studios
        app.kubernetes.io/version: v1.2.3
        helm.sh/chart: studios-9.8.7
        environment: production
        team: platform
- it: should render namespace from release namespace
  template: deployment-proxy.yaml
  release:
    namespace: custom-namespace
  asserts:
  - equal:
      path: metadata.namespace
      value: custom-namespace
- it: shouldn't obey custom selector requests
  template: deployment-proxy.yaml
  set:
    proxy:
      extraOptionsSpec:
        selector:
          matchLabels:
            app: something-else
  asserts:
  - equal:
      path: spec.selector.matchLabels
      value:
        app.kubernetes.io/component: proxy
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/name: studios
- it: should obey strategy in extraOptionsSpec
  template: deployment-proxy.yaml
  set:
    proxy:
      extraOptionsSpec:
        strategy:
          type: RollingUpdate
          rollingUpdate:
            maxUnavailable: 1
            maxSurge: 2
  asserts:
  - equal:
      path: spec.strategy
      value:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 1
          maxSurge: 2
- it: should obey a mix of ignored fields and valid options in extraOptionsSpec
  template: deployment-proxy.yaml
  set:
    proxy:
      extraOptionsSpec:
        replicas: 3
        selector:
          matchLabels:
            app: something-else
        revisionHistoryLimit: 3
  asserts:
  - equal:
      path: spec.replicas
      value: 3
  - equal:
      path: spec.revisionHistoryLimit
      value: 3
  - equal:
      path: spec.selector.matchLabels
      value:
        app.kubernetes.io/component: proxy
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/name: studios
- it: should render nodeSelector via extraOptionsTemplateSpec
  template: deployment-proxy.yaml
  set:
    proxy:
      extraOptionsTemplateSpec:
        nodeSelector:
          disktype: ssd
  asserts:
  - equal:
      path: spec.template.spec.nodeSelector
      value:
        disktype: ssd
- it: should ignore serviceAccountName in extraOptionsTemplateSpec
  template: deployment-proxy.yaml
  set:
    proxy:
      extraOptionsTemplateSpec:
        serviceAccountName: some-other-sa
  asserts:
  - equal:
      path: spec.template.spec.serviceAccountName
      value: release-name-studios-sa
- it: should render default podSecurityContext
  template: deployment-proxy.yaml
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 65532
- it: should disable podSecurityContext when enabled is false
  template: deployment-proxy.yaml
  set:
    proxy:
      podSecurityContext:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should prevent podSecurityContext to be set via extraOptionsTemplateSpec when enabled is false
  template: deployment-proxy.yaml
  set:
    proxy:
      podSecurityContext:
        enabled: false
      extraOptionsTemplateSpec:
        securityContext:
          fsGroup: 2000
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should render custom podSecurityContext
  template: deployment-proxy.yaml
  set:
    proxy:
      podSecurityContext:
        enabled: true
        fsGroup: 2000
        runAsNonRoot: true
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 2000
        runAsNonRoot: true
- it: should render default containerSecurityContext
  template: deployment-proxy.yaml
  asserts:
  - equal:
      path: spec.template.spec.containers[0].securityContext
      value:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        readOnlyRootFilesystem: false
        capabilities:
          drop:
          - ALL
          add:
          - NET_BIND_SERVICE
- it: should disable containerSecurityContext when enabled is false
  template: deployment-proxy.yaml
  set:
    proxy:
      containerSecurityContext:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.containers[0].securityContext
- it: should render custom containerSecurityContext
  template: deployment-proxy.yaml
  set:
    proxy:
      containerSecurityContext:
        enabled: true
        capabilities:
          add:
          - NET_ADMIN
        runAsUser: 2000
        runAsGroup: 2001
        runAsNonRoot: false
        readOnlyRootFilesystem: true
  asserts:
  - equal:
      path: spec.template.spec.containers[0].securityContext
      value:
        capabilities:
          add:
          - NET_ADMIN
          drop:
          - ALL
        readOnlyRootFilesystem: true
        runAsGroup: 2001
        runAsNonRoot: false
        runAsUser: 2000
- it: should render wait-for-platform init container by default
  template: deployment-proxy.yaml
  set:
    global:
      platformServiceAddress: platform.example.com
      platformServicePort: 8080
  asserts:
  - lengthEqual:
      path: spec.template.spec.initContainers
      count: 1
  - equal:
      path: spec.template.spec.initContainers[0].name
      value: wait-for-platform
- it: should render wait-for-platform init container with correct image
  template: deployment-proxy.yaml
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: curlimages/curl:latest
  - equal:
      path: spec.template.spec.initContainers[0].imagePullPolicy
      value: IfNotPresent
- it: should render wait-for-platform init container with correct environment variables
  template: deployment-proxy.yaml
  set:
    global:
      platformServiceAddress: platform.example.com
      platformServicePort: 8080
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].env
      value:
      - name: SLEEP_PERIOD_SECONDS
        value: '5'
      - name: PLATFORM_HOST
        value: platform.example.com
      - name: PLATFORM_PORT
        value: '8080'
- it: should evaluate template expressions in platformServiceAddress for init container
  template: deployment-proxy.yaml
  set:
    global:
      platformServiceAddress: '{{ .Release.Name }}-platform'
      platformServicePort: 8080
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].env[1].value
      value: RELEASE-NAME-platform
- it: should render extraEnvVarsCMs
  template: deployment-proxy.yaml
  set:
    proxy:
      extraEnvVarsCMs:
      - extra-cm-1
      - extra-cm-2
  asserts:
  - contains:
      path: spec.template.spec.containers[0].envFrom
      content:
        configMapRef:
          name: extra-cm-1
  - contains:
      path: spec.template.spec.containers[0].envFrom
      content:
        configMapRef:
          name: extra-cm-2
- it: should render image with registry and digest
  template: deployment-proxy.yaml
  set:
    proxy:
      image:
        registry: my-registry.example.com
        digest: sha256:1234abcdef
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-registry.example.com/private/nf-tower-enterprise/data-studio/connect-proxy@sha256:1234abcdef
- it: should render default caddy-temp-data-volume
  template: deployment-proxy.yaml
  asserts:
  - contains:
      path: spec.template.spec.volumes
      content:
        name: caddy-temp-data-volume
        emptyDir:
          sizeLimit: 100Mi
- it: should render imagePullSecrets from proxy.image.pullSecrets
  template: deployment-proxy.yaml
  set:
    proxy:
      image:
        pullSecrets:
        - secret1
        - secret2
  asserts:
  - equal:
      path: spec.template.spec.imagePullSecrets
      value:
      - name: secret1
      - name: secret2
- it: should not render imagePullSecrets when empty
  template: deployment-proxy.yaml
  set:
    proxy:
      image:
        pullSecrets: []
  asserts:
  - isEmpty:
      path: spec.template.spec.imagePullSecrets
- it: should merge commonLabels and podLabels with podLabels taking precedence
  template: deployment-proxy.yaml
  chart:
    version: 9.8.7
    appVersion: v1.2.3
  set:
    commonLabels:
      environment: common-env
      team: platform
    proxy:
      podLabels:
        environment: pod-env
        component: proxy-component
  asserts:
  - equal:
      path: spec.template.metadata.labels
      value:
        app.kubernetes.io/component: proxy
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: studios
        app.kubernetes.io/version: v1.2.3
        helm.sh/chart: studios-9.8.7
        environment: pod-env
        team: platform
        component: proxy-component
- it: should evaluate template expressions in podLabels
  template: deployment-proxy.yaml
  chart:
    version: 9.8.7
    appVersion: v1.2.3
  set:
    proxy:
      podLabels:
        release: '{{ .Release.Name }}'
        chart: '{{ .Chart.Name }}'
  asserts:
  - equal:
      path: spec.template.metadata.labels.release
      value: RELEASE-NAME
  - equal:
      path: spec.template.metadata.labels.chart
      value: studios
- it: should merge podAnnotations with checksum annotation
  template: deployment-proxy.yaml
  set:
    proxy:
      oidcClientRegistrationToken: test-token
      podAnnotations:
        custom-annotation: custom-value
  asserts:
  - equal:
      path: spec.template.metadata.annotations.custom-annotation
      value: custom-value
  - isNotEmpty:
      path: spec.template.metadata.annotations.checksum/secret
- it: should render wait-for-platform init container with digest
  template: deployment-proxy.yaml
  set:
    initContainerDependencies:
      waitForPlatform:
        image:
          digest: sha256:abcdef1234567890
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: curlimages/curl@sha256:abcdef1234567890
- it: should render wait-for-platform init container with custom registry
  template: deployment-proxy.yaml
  set:
    initContainerDependencies:
      waitForPlatform:
        image:
          registry: my-registry.example.com
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: my-registry.example.com/curlimages/curl:latest
- it: should render extraVolumes
  template: deployment-proxy.yaml
  set:
    proxy:
      extraVolumes:
      - name: extra-volume
        emptyDir:
          sizeLimit: 50Mi
  asserts:
  - contains:
      path: spec.template.spec.volumes
      content:
        name: extra-volume
        emptyDir:
          sizeLimit: 50Mi
- it: should render extraVolumeMounts
  template: deployment-proxy.yaml
  set:
    proxy:
      extraVolumeMounts:
      - name: extra-mount
        mountPath: /custom-path
  asserts:
  - contains:
      path: spec.template.spec.containers[0].volumeMounts
      content:
        name: extra-mount
        mountPath: /custom-path
- it: should not render resources when not specified
  template: deployment-proxy.yaml
  asserts:
  - notExists:
      path: spec.template.spec.containers[0].resources
- it: should render resources when specified
  template: deployment-proxy.yaml
  set:
    proxy:
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 2000m
          memory: 2Gi
  asserts:
  - equal:
      path: spec.template.spec.containers[0].resources
      value:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 2000m
          memory: 2Gi
