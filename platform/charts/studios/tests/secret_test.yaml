# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Studios secrets
templates:
  - secret.yaml
tests:
  - it: should only create secret with OIDC token, not create imagepullsecret by default
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: release-name-studios
      - matchRegex:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          pattern: "^[A-Za-z0-9@_]{32}$"
          decodeBase64: true

  - it: should set the correct env var for the OIDC token
    set:
      proxy:
        oidcClientRegistrationToken: "this-is-the-token"
    asserts:
      - equal:
          path: data["OIDC_CLIENT_REGISTRATION_TOKEN"]
          value: "this-is-the-token"
          decodeBase64: true

  - it: should set the correct env var for the redis password
    set:
      redis:
        password: "this-is-the-password"
    asserts:
      - equal:
          path: data["CONNECT_REDIS_PASSWORD"]
          value: "this-is-the-password"
          decodeBase64: true

  - it: should contain both OIDC token and Redis password when both configured
    set:
      proxy:
        oidcClientRegistrationToken: "my-oidc-token"
      redis:
        password: "my-redis-password"
    asserts:
      - equal:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          value: "my-oidc-token"
          decodeBase64: true
      - equal:
          path: data.CONNECT_REDIS_PASSWORD
          value: "my-redis-password"
          decodeBase64: true

  - it: should not include CONNECT_REDIS_PASSWORD when redis auth is disabled
    set:
      redis:
        password: ""
        existingSecretName: ""
    asserts:
      - notExists:
          path: data["CONNECT_REDIS_PASSWORD"]
      - exists:
          path: data["OIDC_CLIENT_REGISTRATION_TOKEN"]

  - it: should not include CONNECT_REDIS_PASSWORD when using existing secret
    set:
      redis:
        existingSecretName: "my-redis-secret"
        existingSecretKey: "REDIS_PASSWORD"
    asserts:
      - notExists:
          path: data["CONNECT_REDIS_PASSWORD"]
      - exists:
          path: data["OIDC_CLIENT_REGISTRATION_TOKEN"]

  - it: should create imagepullsecret if requested by the user
    set:
      global:
        imageCredentials:
          - registry: example.com
            username: diamond
            password: hunter2
    documentSelector:
      path: metadata.name
      value: release-name-studios-imagepullsecret
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: Secret
      - equal:
          path: type
          value: kubernetes.io/dockerconfigjson
      - equal:
          path: metadata.name
          value: release-name-studios-imagepullsecret
      - equal:
          path: data[".dockerconfigjson"]
          value: '{"auths":{"example.com":{"username":"diamond","password":"hunter2","auth":"ZGlhbW9uZDpodW50ZXIy"}}}'
          decodeBase64: true

  - it: should create imagepullsecret with email
    set:
      global:
        imageCredentials:
          - registry: example.com
            username: diamond
            password: hunter2
            email: me@example.com
    documentSelector:
      path: metadata.name
      value: release-name-studios-imagepullsecret
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: Secret
      - equal:
          path: type
          value: kubernetes.io/dockerconfigjson
      - equal:
          path: metadata.name
          value: release-name-studios-imagepullsecret
      - equal:
          path: data[".dockerconfigjson"]
          value: '{"auths":{"example.com":{"username":"diamond","password":"hunter2","email":"me@example.com","auth":"ZGlhbW9uZDpodW50ZXIy"}}}'
          decodeBase64: true

  - it: should create imagePullSecret with multiple registry credentials
    set:
      global:
        imageCredentials:
          - registry: registry1.example.com
            username: user1
            password: pass1
          - registry: registry2.example.com
            username: user2
            password: pass2
    documentSelector:
      path: metadata.name
      value: release-name-studios-imagepullsecret
    asserts:
      - equal:
          path: data[".dockerconfigjson"]
          value: '{"auths":{"registry1.example.com":{"username":"user1","password":"pass1","auth":"dXNlcjE6cGFzczE="},"registry2.example.com":{"username":"user2","password":"pass2","auth":"dXNlcjI6cGFzczI="}}}'
          decodeBase64: true

  - it: should apply secretLabels to Secret metadata
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      secretLabels:
        custom-label: "my-value"
        app.kubernetes.io/component: "secret"
    asserts:
      - equal:
          path: metadata.labels
          value:
            custom-label: "my-value"
            app.kubernetes.io/component: "secret"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: studios
            app.kubernetes.io/version: "4.5.6"
            helm.sh/chart: studios-1.2.3

  - it: should apply secretAnnotations to Secret metadata
    set:
      secretAnnotations:
        secret.example.com/annotation: "test-value"
        vault.hashicorp.com/agent-inject: "true"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            secret.example.com/annotation: "test-value"
            vault.hashicorp.com/agent-inject: "true"

  - it: should merge commonLabels and secretLabels
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      commonLabels:
        environment: "production"
        team: "platform"
      secretLabels:
        custom-label: "custom-value"
    asserts:
      - equal:
          path: metadata.labels
          value:
            environment: "production"
            team: "platform"
            custom-label: "custom-value"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: studios
            app.kubernetes.io/version: "4.5.6"
            helm.sh/chart: studios-1.2.3

  - it: should merge commonLabels and secretLabels and overwrite
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      commonLabels:
        environment: "production"
        team: "platform"
        value: "common"
      secretLabels:
        custom-label: "custom-value"
        value: "secret"
    asserts:
      - equal:
          path: metadata.labels
          value:
            environment: "production"
            team: "platform"
            custom-label: "custom-value"
            value: "secret"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: studios
            app.kubernetes.io/version: "4.5.6"
            helm.sh/chart: studios-1.2.3

  - it: should merge commonAnnotations and secretAnnotations
    set:
      commonAnnotations:
        common.example.com/annotation: "common-value"
      secretAnnotations:
        secret.example.com/annotation: "secret-value"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            common.example.com/annotation: "common-value"
            secret.example.com/annotation: "secret-value"

  - it: should use correct naming convention for Secret
    release:
      name: my-release
    asserts:
      - equal:
          path: metadata.name
          value: "my-release-studios"

  - it: should render secret in the correct namespace
    release:
      namespace: custom-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: "custom-namespace"

  - it: should apply labels to imagePullSecret
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      global:
        imageCredentials:
          - registry: example.com
            username: user
            password: pass
      commonLabels:
        environment: "production"
      secretLabels:
        custom-label: "custom-value"
    documentSelector:
      path: metadata.name
      value: release-name-studios-imagepullsecret
    asserts:
      - equal:
          path: metadata.labels
          value:
            environment: "production"
            custom-label: "custom-value"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: studios
            app.kubernetes.io/version: "4.5.6"
            helm.sh/chart: studios-1.2.3

  - it: should evaluate template expressions in secretLabels
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      secretLabels:
        release: "{{ .Release.Name }}"
        chart: "{{ .Chart.Name }}"
        version: "{{ .Chart.Version }}"
    asserts:
      - equal:
          path: metadata.labels.release
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.chart
          value: "studios"
      - equal:
          path: metadata.labels.version
          value: "1.2.3"

  - it: should evaluate template expressions in secretAnnotations
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      secretAnnotations:
        release-name: "{{ .Release.Name }}"
        app-version: "{{ .Chart.AppVersion }}"
        namespace: "{{ .Release.Namespace }}"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            release-name: "RELEASE-NAME"
            app-version: "4.5.6"
            namespace: "NAMESPACE"

  - it: should render secret without explicit type (defaults to Opaque)
    asserts:
      - isKind:
          of: Secret
      - notExists:
          path: type

  - it: should have correct apiVersion and kind
    asserts:
      - equal:
          path: apiVersion
          value: v1
      - isKind:
          of: Secret

  - it: should generate OIDC token when not provided
    set:
      proxy:
        oidcClientRegistrationToken: ""
        oidcClientRegistrationTokenSecretName: ""
    asserts:
      - matchRegex:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          pattern: "^[A-Za-z0-9@_]{32}$"
          decodeBase64: true

  - it: should not fetch the OIDC token from existing secret because we mount the user-provided secret on the pod directly
    set:
      proxy:
        oidcClientRegistrationToken: ""
        oidcClientRegistrationTokenSecretName: "unittest-oidc"
        oidcClientRegistrationTokenSecretKey: "OIDC_TOKEN"
    asserts:
      - notExists:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN

  - it: should not create any secret data when all keys come from existing secrets
    set:
      redis:
        password: ""
        existingSecretName: "unittest-redis"
        existingSecretKey: "REDIS_PASSWORD"
      proxy:
        oidcClientRegistrationToken: ""
        oidcClientRegistrationTokenSecretName: "unittest-oidc"
        oidcClientRegistrationTokenSecretKey: "OIDC_TOKEN"
    asserts:
      - equal:
          path: data
          value: null

  - it: should render complete secret with all features enabled
    set:
      redis:
        password: "test-redis-password"
      proxy:
        oidcClientRegistrationToken: "test-oidc-token-12345678901234"
      secretLabels:
        custom-label: "custom-value"
      secretAnnotations:
        custom-annotation: "custom-annotation-value"
      commonLabels:
        environment: "test"
      commonAnnotations:
        team: "platform"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          value: "test-oidc-token-12345678901234"
          decodeBase64: true
      - equal:
          path: data.CONNECT_REDIS_PASSWORD
          value: "test-redis-password"
          decodeBase64: true
      - matchSnapshot: {}

  - it: should allow secretLabels to override commonLabels
    set:
      commonLabels:
        app.kubernetes.io/component: common
        team: "common-team"
      secretLabels:
        app.kubernetes.io/component: secret
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: secret
      - equal:
          path: metadata.labels["team"]
          value: "common-team"

  - it: should allow secretAnnotations to override commonAnnotations
    set:
      commonAnnotations:
        example.com/annotation: "common-value"
        another.com/annotation: "stays"
      secretAnnotations:
        example.com/annotation: "secret-override"
    asserts:
      - equal:
          path: metadata.annotations["example.com/annotation"]
          value: "secret-override"
      - equal:
          path: metadata.annotations["another.com/annotation"]
          value: "stays"

  - it: should render all secrets with annotations when imageCredentials are provided
    set:
      global:
        imageCredentials:
          - registry: example.com
            username: user
            password: pass
      commonAnnotations:
        common-annotation: "value1"
      secretAnnotations:
        secret-annotation: "value2"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations
          value:
            common-annotation: "value1"
            secret-annotation: "value2"

  - it: should render all secrets with labels when imageCredentials are provided
    chart:
      version: "1.2.3"
      appVersion: "4.5.6"
    set:
      global:
        imageCredentials:
          - registry: example.com
            username: user
            password: pass
      commonLabels:
        common-label: "value1"
      secretLabels:
        secret-label: "value2"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.labels
          value:
            common-label: "value1"
            secret-label: "value2"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: studios
            app.kubernetes.io/version: "4.5.6"
            helm.sh/chart: studios-1.2.3

  # Tests for the fix: OIDC token secret key handling
  - it: should use correct default OIDC secret key OIDC_CLIENT_REGISTRATION_TOKEN when not specified
    set:
      proxy:
        oidcClientRegistrationToken: "test-token-value"
        oidcClientRegistrationTokenSecretKey: ""
    asserts:
      - equal:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          value: "test-token-value"
          decodeBase64: true

  - it: should use custom secret key when oidcClientRegistrationTokenSecretKey is provided
    set:
      proxy:
        oidcClientRegistrationToken: "test-token"
        oidcClientRegistrationTokenSecretKey: "CUSTOM_OIDC_KEY"
    asserts:
      - equal:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          value: "test-token"
          decodeBase64: true

  - it: should not include OIDC token when using existing secret with custom key
    set:
      proxy:
        oidcClientRegistrationToken: ""
        oidcClientRegistrationTokenSecretName: "my-external-secret"
        oidcClientRegistrationTokenSecretKey: "CUSTOM_TOKEN_KEY"
    asserts:
      - notExists:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN

  # Tests for the fix: Redis secret key handling
  - it: should use correct default Redis secret key CONNECT_REDIS_PASSWORD in managed secret
    set:
      redis:
        password: "my-redis-pass"
    asserts:
      - exists:
          path: data.CONNECT_REDIS_PASSWORD
      - equal:
          path: data.CONNECT_REDIS_PASSWORD
          value: "my-redis-pass"
          decodeBase64: true

  - it: should not include Redis password when using existing secret
    set:
      redis:
        password: ""
        existingSecretName: "my-redis-secret"
        existingSecretKey: "REDIS_PASS"
    asserts:
      - notExists:
          path: data.CONNECT_REDIS_PASSWORD
      - exists:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN

  # Integration tests with both custom secret keys
  - it: should handle both OIDC and Redis with custom existingSecretKey values
    set:
      proxy:
        oidcClientRegistrationToken: ""
        oidcClientRegistrationTokenSecretName: "external-oidc"
        oidcClientRegistrationTokenSecretKey: "MY_OIDC_TOKEN"
      redis:
        password: ""
        existingSecretName: "external-redis"
        existingSecretKey: "MY_REDIS_PASSWORD"
    asserts:
      - notExists:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
      - notExists:
          path: data.CONNECT_REDIS_PASSWORD
      - equal:
          path: data
          value: null

  - it: should properly use helpers when OIDC uses external secret and Redis uses inline password
    set:
      proxy:
        oidcClientRegistrationToken: ""
        oidcClientRegistrationTokenSecretName: "external-oidc-secret"
        oidcClientRegistrationTokenSecretKey: "OIDC_KEY"
      redis:
        password: "inline-redis-password"
    asserts:
      - notExists:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
      - exists:
          path: data.CONNECT_REDIS_PASSWORD
      - equal:
          path: data.CONNECT_REDIS_PASSWORD
          value: "inline-redis-password"
          decodeBase64: true

  - it: should properly use helpers when Redis uses external secret and OIDC uses inline token
    set:
      proxy:
        oidcClientRegistrationToken: "inline-oidc-token"
        oidcClientRegistrationTokenSecretKey: ""
      redis:
        password: ""
        existingSecretName: "external-redis-secret"
        existingSecretKey: "REDIS_KEY"
    asserts:
      - equal:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
          value: "inline-oidc-token"
          decodeBase64: true
      - notExists:
          path: data.CONNECT_REDIS_PASSWORD

  # Template expression evaluation tests
  - it: should evaluate template expressions in oidcClientRegistrationTokenSecretKey
    set:
      proxy:
        oidcClientRegistrationToken: "test-token"
        oidcClientRegistrationTokenSecretKey: "{{ .Release.Name }}_OIDC"
    asserts:
      - exists:
          path: data.OIDC_CLIENT_REGISTRATION_TOKEN
