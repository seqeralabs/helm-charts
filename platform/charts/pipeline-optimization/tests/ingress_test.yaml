# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Pipeline Optimization ingress
templates:
  - ingress.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
  - it: should not render ingress when disabled
    set:
      ingress:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ingress when enabled
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress

  - it: should set correct hostname
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[0].host
          value: optimization.example.com

  - it: should evaluate template expressions in pipelineOptimizationExternalDomain
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "{{ .Release.Name }}.example.com"
    asserts:
      - equal:
          path: spec.rules[0].host
          value: RELEASE-NAME.example.com

  - it: should apply ingress class
    set:
      ingress:
        enabled: true
        ingressClassName: "nginx"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: should not set ingressClassName when empty
    set:
      ingress:
        enabled: true
        ingressClassName: ""
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - notExists:
          path: spec.ingressClassName

  - it: should apply ingress annotations
    set:
      ingress:
        enabled: true
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: "/"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/rewrite-target"]
          value: "/"
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "true"

  - it: should evaluate template expressions in ingress annotations
    set:
      ingress:
        enabled: true
        annotations:
          release-name: "{{ .Release.Name }}"
          app-version: "{{ .Chart.AppVersion }}"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.annotations["release-name"]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.annotations["app-version"]
          value: "v9.9.9"

  - it: should merge commonAnnotations with ingress annotations
    set:
      ingress:
        enabled: true
        annotations:
          ingress-specific: "value1"
      commonAnnotations:
        common-annotation: "value2"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.annotations["ingress-specific"]
          value: value1
      - equal:
          path: metadata.annotations["common-annotation"]
          value: value2

  - it: should allow ingress annotations to override commonAnnotations
    set:
      ingress:
        enabled: true
        annotations:
          annotation-key: "from-ingress"
      commonAnnotations:
        annotation-key: "from-common"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.annotations["annotation-key"]
          value: "from-ingress"

  - it: should apply ingress extraLabels
    set:
      ingress:
        enabled: true
        extraLabels:
          custom-label: "custom-value"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.labels["custom-label"]
          value: custom-value

  - it: should evaluate template expressions in ingress extraLabels
    set:
      ingress:
        enabled: true
        extraLabels:
          release: "{{ .Release.Name }}"
          chart: "{{ .Chart.Name }}"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.labels.release
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.chart
          value: "pipeline-optimization"

  - it: should merge commonLabels with ingress extraLabels
    set:
      ingress:
        enabled: true
        extraLabels:
          custom-label: "custom-value"
      commonLabels:
        common-label: "common-value"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.labels["custom-label"]
          value: custom-value
      - equal:
          path: metadata.labels["common-label"]
          value: common-value

  - it: should include standard labels
    chart:
      version: 9.8.7
      appVersion: v1.2.3-asdf
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: pipeline-optimization
            app.kubernetes.io/version: v1.2.3-asdf
            helm.sh/chart: pipeline-optimization-9.8.7

  - it: should use default path when not set
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: "/"

  - it: should use custom path when set
    set:
      ingress:
        enabled: true
        path: "/*"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: "/*"

  - it: should use default pathType
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: ImplementationSpecific

  - it: should use custom pathType
    set:
      ingress:
        enabled: true
        defaultPathType: "Prefix"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Prefix

  - it: should not create additional rules without extraHosts
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - lengthEqual:
          path: spec.rules
          count: 1

  - it: should configure TLS when set
    set:
      ingress:
        enabled: true
        tls:
          - hosts:
              - optimization.example.com
            secretName: optimization-tls
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.tls[0].hosts[0]
          value: optimization.example.com
      - equal:
          path: spec.tls[0].secretName
          value: optimization-tls

  - it: should evaluate template expressions in TLS configuration
    set:
      ingress:
        enabled: true
        tls:
          - hosts:
              - '{{ .Values.global.pipelineOptimizationExternalDomain }}'
            secretName: '{{ printf "%s-tls" (include "common.names.fullname" .) }}'
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.tls[0].hosts[0]
          value: optimization.example.com
      - equal:
          path: spec.tls[0].secretName
          value: release-name-pipeline-optimization-tls

  - it: should configure multiple TLS entries
    set:
      ingress:
        enabled: true
        tls:
          - hosts:
              - optimization.example.com
            secretName: optimization-tls
          - hosts:
              - user-data.optimization.example.com
            secretName: content-tls
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - lengthEqual:
          path: spec.tls
          count: 2
      - equal:
          path: spec.tls[0].secretName
          value: optimization-tls
      - equal:
          path: spec.tls[1].secretName
          value: content-tls

  - it: should not render TLS when empty
    set:
      ingress:
        enabled: true
        tls: []
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - notExists:
          path: spec.tls

  - it: should configure defaultBackend when set
    set:
      ingress:
        enabled: true
        defaultBackend:
          service:
            name: default-backend
            port:
              number: 8080
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.defaultBackend.service.name
          value: default-backend
      - equal:
          path: spec.defaultBackend.service.port.number
          value: 8080

  - it: should evaluate template expressions in defaultBackend
    set:
      ingress:
        enabled: true
        defaultBackend:
          service:
            name: '{{ printf "%s-custom" (include "common.names.fullname" .) }}'
            port:
              number: '{{ .Values.service.http.targetPort }}'
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.defaultBackend.service.name
          value: release-name-pipeline-optimization-custom
      - equal:
          path: spec.defaultBackend.service.port.number
          value: 8090

  - it: should not render defaultBackend when empty
    set:
      ingress:
        enabled: true
        defaultBackend: {}
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - notExists:
          path: spec.defaultBackend

  - it: should configure extraHosts
    set:
      ingress:
        enabled: true
        extraHosts:
          - host: api.example.com
            paths:
              - path: /api
                pathType: Prefix
                serviceName: api-service
                portNumber: "8080"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - lengthEqual:
          path: spec.rules
          count: 2
      - equal:
          path: spec.rules[1].host
          value: api.example.com
      - equal:
          path: spec.rules[1].http.paths[0].path
          value: /api
      - equal:
          path: spec.rules[1].http.paths[0].pathType
          value: Prefix
      - equal:
          path: spec.rules[1].http.paths[0].backend.service.name
          value: api-service
      - equal:
          path: spec.rules[1].http.paths[0].backend.service.port.number
          value: 8080

  - it: should evaluate template expressions in extraHosts
    set:
      ingress:
        enabled: true
        extraHosts:
          - host: '{{ printf "api.%s" .Values.global.pipelineOptimizationExternalDomain }}'
            paths:
              - path: /
                serviceName: '{{ include "common.names.fullname" . }}'
                portNumber: '{{ .Values.service.http.targetPort }}'
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[1].host
          value: api.optimization.example.com
      - equal:
          path: spec.rules[1].http.paths[0].backend.service.name
          value: release-name-pipeline-optimization
      - equal:
          path: spec.rules[1].http.paths[0].backend.service.port.number
          value: 8090

  - it: should configure extraHosts with multiple paths
    set:
      ingress:
        enabled: true
        extraHosts:
          - host: api.example.com
            paths:
              - path: /v1
                pathType: Prefix
                serviceName: api-v1
                portNumber: "8080"
              - path: /v2
                pathType: Prefix
                serviceName: api-v2
                portNumber: "8081"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - lengthEqual:
          path: spec.rules[1].http.paths
          count: 2
      - equal:
          path: spec.rules[1].http.paths[0].path
          value: /v1
      - equal:
          path: spec.rules[1].http.paths[1].path
          value: /v2

  - it: should use defaultPathType for extraHosts paths when pathType not specified
    set:
      ingress:
        enabled: true
        defaultPathType: Exact
        extraHosts:
          - host: api.example.com
            paths:
              - path: /api
                serviceName: api-service
                portNumber: "8080"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: spec.rules[1].http.paths[0].pathType
          value: Exact

  - it: should handle empty extraHosts array
    set:
      ingress:
        enabled: true
        extraHosts: []
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - lengthEqual:
          path: spec.rules
          count: 1

  - it: should use custom namespace when specified
    set:
      ingress:
        enabled: true
      namespaceOverride: custom-namespace
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  - it: should use correct naming convention for ingress
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - equal:
          path: metadata.name
          value: release-name-pipeline-optimization

  - it: should use correct API version
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - matchRegex:
          path: apiVersion
          pattern: ^networking\.k8s\.io/v1

  - it: should render complete ingress with default values
    set:
      ingress:
        enabled: true
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
    asserts:
      - matchSnapshot: {}

  - it: should render complete ingress with all options
    set:
      ingress:
        enabled: true
        ingressClassName: nginx
        path: "/*"
        contentPath: "/content/*"
        defaultPathType: Prefix
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt
        extraLabels:
          environment: production
        tls:
          - hosts:
              - optimization.example.com
              - user-data.optimization.example.com
            secretName: wildcard-tls
        defaultBackend:
          service:
            name: default-backend
            port:
              number: 8080
        extraHosts:
          - host: api.optimization.example.com
            paths:
              - path: /
                serviceName: api-service
                portNumber: "9090"
      global:
        pipelineOptimizationExternalDomain: "optimization.example.com"
      commonLabels:
        team: platform
      commonAnnotations:
        common-annotation: common-value
    asserts:
      - matchSnapshot: {}
