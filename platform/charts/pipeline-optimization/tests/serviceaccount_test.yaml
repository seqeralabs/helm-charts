# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Pipeline Optimization serviceaccount
templates:
  - serviceaccount.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
  - it: should render 1 serviceaccount by default
    asserts:
      - hasDocuments:
          count: 1

  - it: should render serviceaccount with default values
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: release-name-pipeline-optimization-sa
      - equal:
          path: automountServiceAccountToken
          value: false
      - matchSnapshot: {}

  - it: should not render a serviceaccount if user provides an existing service account by name
    set:
      serviceAccount:
        name: custom-service-account
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom namespace when specified
    set:
      namespaceOverride: custom-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  - it: should enable automountServiceAccountToken when requested as boolean
    set:
      serviceAccount:
        automountServiceAccountToken: true
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should enable automountServiceAccountToken when requested as string
    set:
      serviceAccount:
        automountServiceAccountToken: "true"
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should disable automountServiceAccountToken by default
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: false

  - it: should render a serviceaccount with image pull secret created by Helm
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-pipeline-optimization-imagepullsecret

  - it: should render a serviceaccount with multiple image pull secrets from global credentials
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-pipeline-optimization-imagepullsecret

  - it: should render a serviceaccount with user-provided image pull secrets only
    set:
      serviceAccount:
        imagePullSecretNames:
          - custom-secret-1
          - custom-secret-2
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: custom-secret-1
            - name: custom-secret-2

  - it: should render a serviceaccount with both Helm-created and user-provided image pull secrets
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      serviceAccount:
        imagePullSecretNames:
          - custom-secret-1
          - custom-secret-2
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-pipeline-optimization-imagepullsecret
            - name: custom-secret-1
            - name: custom-secret-2

  - it: should render imagePullSecrets as null when none configured
    asserts:
      - equal:
          path: imagePullSecrets
          value: null

  - it: should apply commonLabels to serviceaccount metadata
    set:
      commonLabels:
        team: platform
        environment: production
    asserts:
      - equal:
          path: metadata.labels.team
          value: platform
      - equal:
          path: metadata.labels.environment
          value: production

  - it: should apply commonAnnotations to serviceaccount metadata
    set:
      commonAnnotations:
        example.com/annotation: "value"
    asserts:
      - equal:
          path: metadata.annotations["example.com/annotation"]
          value: "value"

  - it: should apply serviceAccount.annotations to serviceaccount metadata
    set:
      serviceAccount:
        annotations:
          sa-annotation-key: sa-annotation-value
    asserts:
      - equal:
          path: metadata.annotations["sa-annotation-key"]
          value: "sa-annotation-value"

  - it: should merge commonAnnotations and serviceAccount.annotations
    set:
      commonAnnotations:
        common-annotation-key: common-annotation-value
        annotation-to-override: "this-will-be-overridden"
      serviceAccount:
        annotations:
          sa-annotation-key: sa-annotation-value
          annotation-to-override: "this-overrides-the-commonAnnotations"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            common-annotation-key: common-annotation-value
            annotation-to-override: "this-overrides-the-commonAnnotations"
            sa-annotation-key: sa-annotation-value

  - it: should evaluate template expressions in commonLabels
    set:
      commonLabels:
        release: "{{ .Release.Name }}"
        chart: "{{ .Chart.Name }}"
    asserts:
      - equal:
          path: metadata.labels.release
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.chart
          value: "pipeline-optimization"

  - it: should evaluate template expressions in commonAnnotations
    set:
      commonAnnotations:
        release-name: "{{ .Release.Name }}"
        app-version: "{{ .Chart.AppVersion }}"
    asserts:
      - equal:
          path: metadata.annotations["release-name"]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.annotations["app-version"]
          value: "v9.9.9"

  - it: should evaluate template expressions in serviceAccount.annotations
    set:
      serviceAccount:
        annotations:
          release-name: "{{ .Release.Name }}"
          app-version: "{{ .Chart.AppVersion }}"
    asserts:
      - equal:
          path: metadata.annotations["release-name"]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.annotations["app-version"]
          value: "v9.9.9"

  - it: should include standard labels
    chart:
      version: 9.8.7
      appVersion: v1.2.3-asdf
    asserts:
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: pipeline-optimization
            app.kubernetes.io/version: v1.2.3-asdf
            helm.sh/chart: pipeline-optimization-9.8.7

  - it: should include standard labels with custom commonLabels
    chart:
      version: 9.8.7
      appVersion: v1.2.3-asdf
    set:
      commonLabels:
        custom-label-key: custom-label-value
    asserts:
      - equal:
          path: metadata.labels
          value:
            custom-label-key: custom-label-value
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: pipeline-optimization
            app.kubernetes.io/version: v1.2.3-asdf
            helm.sh/chart: pipeline-optimization-9.8.7

  - it: should have correct apiVersion and kind
    asserts:
      - equal:
          path: apiVersion
          value: v1
      - isKind:
          of: ServiceAccount

  - it: should use correct naming convention for serviceaccount
    asserts:
      - equal:
          path: metadata.name
          value: release-name-pipeline-optimization-sa
      - matchRegex:
          path: metadata.name
          pattern: ^release-name-pipeline-optimization-sa$

  - it: should use release name in serviceaccount name
    release:
      name: my-custom-release
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-release-pipeline-optimization-sa

  - it: should use default namespace if not overridden
    asserts:
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: should render serviceaccount with all custom values
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      serviceAccount:
        automountServiceAccountToken: true
        imagePullSecretNames:
          - custom-secret-1
        annotations:
          sa-annotation: sa-value
      commonLabels:
        team: platform
      commonAnnotations:
        common-annotation: common-value
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-pipeline-optimization-imagepullsecret
            - name: custom-secret-1
      - equal:
          path: metadata.labels.team
          value: platform
      - equal:
          path: metadata.annotations["sa-annotation"]
          value: sa-value
      - equal:
          path: metadata.annotations["common-annotation"]
          value: common-value
      - matchSnapshot: {}

  - it: should render imagePullSecrets as null when no credentials provided
    set:
      global:
        imageCredentials: []
      serviceAccount:
        imagePullSecretNames: []
    asserts:
      - equal:
          path: imagePullSecrets
          value: null

  - it: should allow serviceAccount.annotations to override commonAnnotations
    set:
      commonAnnotations:
        annotation-key: "from-common"
      serviceAccount:
        annotations:
          annotation-key: "from-serviceaccount"
    asserts:
      - equal:
          path: metadata.annotations["annotation-key"]
          value: "from-serviceaccount"
