# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 - 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Pipeline Optimization deployment
templates:
  - deployment.yaml
  - secret.yaml
  - configmap.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
  - it: should produce a Deployment resource with minimal values
    template: deployment.yaml
    asserts:
      - matchSnapshot:
          path: spec.template.spec

  - it: should handle image tag and digest configuration
    template: deployment.yaml
    set:
      image:
        registry: my-custom-registry.io
        repository: my-custom-repo/my-backend-image
        tag: "2.0.0"
        digest: "sha256:abcd1234"
        pullPolicy: Always
        pullSecrets:
          - my-custom-pull-secret
          - my-custom-pull-secret2
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "my-custom-registry.io/my-custom-repo/my-backend-image@sha256:abcd1234"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
      - equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: my-custom-pull-secret
            - name: my-custom-pull-secret2

  - it: should render the deployment with the correct checksums, labels and annotations
    template: deployment.yaml
    chart:
      version: "9.9.9+test"
      appVersion: "9.9.9"
    set:
      global:
        platformServicePort: 8080 # set this otherwise when tests are performed on subchart only the default 8443 below is used
      database:
        host: swell-db-host
        port: 3306
        name: swell-db-name
        username: swell-db-user
        password: swell-db-password
      platformDatabase:
        host: platform-db-host
        port: 3306
        name: platform-db-name
        username: platform-db-user
        password: platform-db-password
      commonLabels:
        key123: this-should-be-overridden-in-pod-labels
        key456: this-should-not-be-overridden
        key789: "{{ .Values.global.platformServicePort | default 8443 }}"
      commonAnnotations:
        common-annotation-key: common-annotation-value
      podLabels:
        key123: this-overrides-the-commonLabels
      podAnnotations:
        pod-annotation-key: pod-annotation-value
        pod-annotation-key2: "{{ .Values.global.platformServicePort | default 8443 }}"
    asserts:
      - matchSnapshot: {}

  - it: should handle extraOptionsSpec with ignored and valid fields
    template: deployment.yaml
    set:
      extraOptionsSpec:
        replicas: 3
        selector:
          matchLabels:
            app: something-else
        revisionHistoryLimit: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3
      - equal:
          path: spec.revisionHistoryLimit
          value: 3
      - equal:
          path: spec.selector.matchLabels
          value:
            app.kubernetes.io/component: pipeline-optimization
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: pipeline-optimization

  - it: should handle extraOptionsTemplateSpec with ignored managed fields
    template: deployment.yaml
    set:
      extraOptionsTemplateSpec:
        serviceAccountName: "some-other-sa"
        dnsPolicy: ClusterFirstWithHostNet
        nodeSelector:
          disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: release-name-pipeline-optimization-sa
      - equal:
          path: spec.template.spec.dnsPolicy
          value: ClusterFirstWithHostNet
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            disktype: ssd

  - it: should handle podSecurityContext with custom values
    template: deployment.yaml
    set:
      podSecurityContext:
        enabled: true
        fsGroup: 2000
        runAsUser: 1000
    asserts:
      - notExists:
          path: spec.template.spec.securityContext.enabled
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 2000
            runAsUser: 1000

  - it: should disable podSecurityContext when enabled is false
    template: deployment.yaml
    set:
      podSecurityContext:
        enabled: false
      extraOptionsTemplateSpec:
        securityContext:
          fsGroup: 2000
    asserts:
      - notExists:
          path: spec.template.spec.securityContext

  - it: should handle container securityContext with custom capabilities
    template: deployment.yaml
    set:
      containerSecurityContext:
        enabled: true
        capabilities:
          add:
            - NET_ADMIN
        runAsUser: 2000
        runAsNonRoot: false
        readOnlyRootFilesystem: false
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].securityContext.enabled
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities
          value:
            add:
              - NET_ADMIN
            drop:
              - ALL

  - it: should configure environment variables with extraEnvVars and template evaluation
    template: deployment.yaml
    set:
      service:
        http:
          targetPort: 8090
      extraEnvVars:
        - name: CUSTOM_PORT
          value: "{{ .Values.service.http.targetPort }}"
        - name: STATIC_VAR
          value: "static-value"
      extraEnvVarsCMs: [extra-env-vars-cm1]
      extraEnvVarsSecrets: [extra-env-vars-secret1]
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_PORT
            value: "8090"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: STATIC_VAR
            value: "static-value"
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: extra-env-vars-cm1

  - it: should render default initContainers that wait for required services
    template: deployment.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 3
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-pipeline-optimization-db
      - equal:
          path: spec.template.spec.initContainers[1].name
          value: wait-for-platform-db
      - equal:
          path: spec.template.spec.initContainers[2].name
          value: migrate-db

  - it: should render initContainer with appropriate env vars from external secrets
    template: deployment.yaml
    kubernetesProvider:
      scheme:
        "v1/Secret":
          gvr:
            version:  "v1"
            resource: "secrets"
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            name: my-db-secret
            namespace: NAMESPACE
          data:
            my-db-password-key: "bXktZGItcGFzc3dvcmQxMjM="
    set:
      database:
        host: my-swell-db
        name: asdf
        port: 6380
        username: username123
        password: my-swell-password123
      platformDatabase:
        host: my-platform-db
        port: 3307
        name: my-db-name
        username: my-db-username
        existingSecretName: my-db-secret
        existingSecretKey: my-db-password-key
    asserts:
      - equal:
          path: spec.template.spec.initContainers[1].env[1].value
          value: "my-platform-db"
      - equal:
          path: spec.template.spec.initContainers[1].env[5].valueFrom.secretKeyRef.name
          value: my-db-secret
      - equal:
          path: spec.template.spec.initContainers[1].env[5].valueFrom.secretKeyRef.key
          value: my-db-password-key

  - it: should customize wait init containers with resources and security context
    template: deployment.yaml
    set:
      initContainerDependencies:
        waitForMySQL:
          resources:
            requests:
              cpu: "0.1"
              memory: "25Mi"
            limits:
              memory: "50Mi"
          securityContext:
            runAsUser: 1000
            runAsNonRoot: true
          image:
            registry: my-registry.io
            repository: custom-mysql
            tag: "8"
            pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].resources.requests.cpu
          value: "0.1"
      - equal:
          path: spec.template.spec.initContainers[0].securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: my-registry.io/custom-mysql:8

  - it: should disable initContainers that wait for required services
    template: deployment.yaml
    set:
      initContainerDependencies:
        enabled: false
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 1
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: migrate-db

  - it: should render extra user-defined initContainers
    template: deployment.yaml
    set:
      initContainers:
        - name: extra-init-container1
          image: busybox:latest
          command: ["sh", "-c", "echo Hello"]
        - name: extra-init-container2
          image: alpine:latest
          command: ["sh", "-c", "echo World"]
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 5
      - equal:
          path: spec.template.spec.initContainers[3].name
          value: extra-init-container1
      - equal:
          path: spec.template.spec.initContainers[4].name
          value: extra-init-container2

  - it: should customize DB migration init container
    template: deployment.yaml
    set:
      dbMigrationInitContainer:
        image:
          registry: my-registry.io
          repository: my-custom/migration-image
          tag: "ignored"
          digest: "sha256:abcdef123456"
          pullPolicy: Always
        command: ["/custom/migrate.sh"]
        args: ["--verbose", "--force"]
      image:
        pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.initContainers[2].name
          value: migrate-db
      - equal:
          path: spec.template.spec.initContainers[2].image
          value: my-registry.io/my-custom/migration-image@sha256:abcdef123456
      - equal:
          path: spec.template.spec.initContainers[2].command
          value: ["/custom/migrate.sh"]
      - equal:
          path: spec.template.spec.initContainers[2].args
          value: ["--verbose", "--force"]

  - it: should handle volumes and volume mounts
    template: deployment.yaml
    set:
      extraVolumes:
        - name: extra-volume-1
          emptyDir: {}
        - name: extra-volume-2
          configMap:
            name: my-config
      extraVolumeMounts:
        - name: extra-volume-1
          mountPath: /extra/path1
        - name: extra-volume-2
          mountPath: /extra/path2
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 3
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 3
      - equal:
          path: spec.template.spec.volumes[0].name
          value: tmp-volume
      - equal:
          path: spec.template.spec.volumes[0].emptyDir.sizeLimit
          value: 1Gi
      - equal:
          path: spec.template.spec.volumes[1].name
          value: extra-volume-1

  - it: should configure probes with various port formats
    template: deployment.yaml
    set:
      service:
        port: "8089"
      livenessProbe:
        enabled: true
        httpGet:
          path: /api/v1/health
          port: "{{ .Values.service.port }}"
        initialDelaySeconds: 10
        periodSeconds: 20
      readinessProbe:
        httpGet:
          path: /api/v1/health
          port: "8088"
        initialDelaySeconds: 15
        periodSeconds: 25
      startupProbe:
        enabled: true
        httpGet:
          path: /api/v1/health
          port: 8087
        initialDelaySeconds: 20
        periodSeconds: 30
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: 8087
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8089
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8088

  - it: should configure tcpSocket probes with templated ports
    template: deployment.yaml
    set:
      service:
        http:
          targetPort: "9090"
      livenessProbe:
        enabled: true
        tcpSocket:
          port: "{{ .Values.service.http.targetPort }}"
      readinessProbe:
        tcpSocket:
          port: "9091"
      startupProbe:
        enabled: true
        tcpSocket:
          port: 9092
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.tcpSocket.port
          value: 9090
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.tcpSocket.port
          value: 9091
      - equal:
          path: spec.template.spec.containers[0].startupProbe.tcpSocket.port
          value: 9092

  - it: should disable probes
    template: deployment.yaml
    set:
      livenessProbe:
        enabled: false
      readinessProbe:
        enabled: false
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].livenessProbe
      - notExists:
          path: spec.template.spec.containers[0].readinessProbe
      - notExists:
          path: spec.template.spec.containers[0].startupProbe

  - it: should mount user-provided secrets with custom keys
    template: deployment.yaml
    set:
      database:
        existingSecretName: "my-db-secret1"
        existingSecretKey: "my-db-secret-key1"
      platformDatabase:
        existingSecretName: "my-db-secret2"
        existingSecretKey: "my-db-secret-key2"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.name
          value: my-db-secret1
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.key
          value: my-db-secret-key1
      - equal:
          path: spec.template.spec.containers[0].env[2].valueFrom.secretKeyRef.name
          value: my-db-secret2
      - equal:
          path: spec.template.spec.containers[0].env[2].valueFrom.secretKeyRef.key
          value: my-db-secret-key2

  - it: should use custom command and args
    template: deployment.yaml
    set:
      command: ["/bin/custom-backend-start"]
      args: ["--custom-arg1", "value1"]
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/bin/custom-backend-start"]
      - equal:
          path: spec.template.spec.containers[0].args
          value: ["--custom-arg1", "value1"]

  - it: should render custom resources
    template: deployment.yaml
    set:
      resources:
        limits:
          memory: 1Gi
        requests:
          cpu: "1"
          memory: 512Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              memory: 1Gi
            requests:
              cpu: "1"
              memory: 512Mi

  - it: should handle empty resources gracefully
    template: deployment.yaml
    set:
      resources: {}
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].resources

  - it: should not render command when empty
    template: deployment.yaml
    set:
      command: []
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].command

  - it: should not render args when empty
    template: deployment.yaml
    set:
      args: []
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].args

  - it: should render a templated integer value as integer
    template: deployment.yaml
    set:
      service:
        port: "8444"
      extraOptionsSpec:
        replicas: '{{ .Values.service.port }}'
    asserts:
      - equal:
          path: spec.replicas
          value: 8444

  - it: should create a Deployment with correct apiVersion and kind
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: release-name-pipeline-optimization

  - it: should use custom namespace
    template: deployment.yaml
    release:
      namespace: custom-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  - it: should render custom serviceAccount name
    template: deployment.yaml
    set:
      serviceAccount:
        name: my-custom-sa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: my-custom-sa

  - it: should apply podLabels to pod template but not selector
    template: deployment.yaml
    set:
      podLabels:
        custom-pod-label: custom-value
        another-label: another-value
    asserts:
      - equal:
          path: spec.selector.matchLabels
          value:
            app.kubernetes.io/component: pipeline-optimization
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: pipeline-optimization
      - equal:
          path: spec.template.metadata.labels.custom-pod-label
          value: custom-value
      - equal:
          path: spec.template.metadata.labels.another-label
          value: another-value

  - it: should use azure-specific image for the pipeline-optimization container
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            pipelineOptimization:
              registry: my-azure-registry.azurecr.io
              image: my-groundswell
              tag: 1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: my-azure-registry.azurecr.io/my-groundswell:1.2.3

  - it: should fall back to default pipeline-optimization image when azure pipelineOptimization.image is empty
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            pipelineOptimization:
              registry: my-azure-registry.azurecr.io
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: private/nf-tower-enterprise/groundswell:v9.9.9

  - it: should evaluate templates in azure override fields for the pipeline-optimization container
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            pipelineOptimization:
              registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
              image: '{{ printf "my-%s" "groundswell" }}'
              tag: '{{ .Chart.AppVersion }}'
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: my-registry-azurecr.io/my-groundswell:v9.9.9

  - it: should use azure-specific image for the migrate-db initContainer
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            pipelineOptimizationMigrateDB:
              registry: my-azure-registry.azurecr.io
              image: my-migrate-db
              tag: 1.2.3
    asserts:
      - equal:
          path: spec.template.spec.initContainers[2].image
          value: my-azure-registry.azurecr.io/my-migrate-db:1.2.3

  - it: should fall back to default migrate-db image when azure pipelineOptimizationMigrateDB.image is empty
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            pipelineOptimizationMigrateDB:
              registry: my-azure-registry.azurecr.io
    asserts:
      - equal:
          path: spec.template.spec.initContainers[2].image
          value: private/nf-tower-enterprise/groundswell:v9.9.9

  - it: should evaluate templates in azure override fields for migrate-db initContainer
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            pipelineOptimizationMigrateDB:
              registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
              image: '{{ printf "my-%s" "migrate-db" }}'
              tag: '{{ .Chart.AppVersion }}'
    asserts:
      - equal:
          path: spec.template.spec.initContainers[2].image
          value: my-registry-azurecr.io/my-migrate-db:v9.9.9

  - it: should use azure-specific image for the wait-for-MySQL initContainers
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            waitForMySQL:
              registry: my-azure-registry.azurecr.io
              image: my-mysql-wait
              tag: 1.2.3
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: my-azure-registry.azurecr.io/my-mysql-wait:1.2.3
      - equal:
          path: spec.template.spec.initContainers[1].image
          value: my-azure-registry.azurecr.io/my-mysql-wait:1.2.3

  - it: should fall back to default wait-for-MySQL image when azure waitForMySQL.image is empty
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            waitForMySQL:
              registry: my-azure-registry.azurecr.io
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: mysql:9
      - equal:
          path: spec.template.spec.initContainers[1].image
          value: mysql:9

  - it: should evaluate templates in azure override fields for wait-for-MySQL initContainers
    template: deployment.yaml
    set:
      global:
        azure:
          images:
            waitForMySQL:
              registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
              image: '{{ printf "my-%s" "mysql" }}'
              tag: '{{ .Chart.AppVersion }}'
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: my-registry-azurecr.io/my-mysql:v9.9.9
      - equal:
          path: spec.template.spec.initContainers[1].image
          value: my-registry-azurecr.io/my-mysql:v9.9.9
