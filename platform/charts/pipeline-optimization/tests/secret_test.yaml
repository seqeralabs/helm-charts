# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Pipeline Optimization secrets
templates:
  - secret.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
  - it: should render 1 secret by default, when no pull credentials are provided
    asserts:
      - hasDocuments:
          count: 1

  - it: should render secret with default values
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: release-name-pipeline-optimization
      - equal:
          path: type
          value: Opaque

  - it: should include SWELL_DB_PASSWORD when not using existing secret
    set:
      database:
        password: "my-swell-password"
    asserts:
      - equal:
          path: data.SWELL_DB_PASSWORD
          value: my-swell-password
          decodeBase64: true

  - it: should not fetch the SWELL_DB_PASSWORD from existing secret because we mount the user-provided secret on the pod directly
    set:
      database:
        existingSecretName: "unittest-db-secret"
    asserts:
      - notExists:
          path: data.SWELL_DB_PASSWORD

  - it: should include TOWER_DB_PASSWORD when not using existing secret
    set:
      platformDatabase:
        password: "my-platform-password"
    asserts:
      - equal:
          path: data.TOWER_DB_PASSWORD
          value: my-platform-password
          decodeBase64: true

  - it: should not fetch the TOWER_DB_PASSWORD from existing secret because we mount the user-provided secret on the pod directly
    set:
      platformDatabase:
        existingSecretName: "unittest-platform-secret"
    asserts:
      - notExists:
          path: data.TOWER_DB_PASSWORD

  - it: should not create any secret when all keys are coming from existing secrets
    set:
      database:
        existingSecretName: "unittest-db-secret"
      platformDatabase:
        existingSecretName: "unittest-platform-secret"
    asserts:
      - equal:
          path: data
          value: null

  - it: should create the imagepullsecret if credentials are provided
    documentSelector:
      path: metadata.name
      value: release-name-pipeline-optimization-imagepullsecret
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: Secret
      - equal:
          path: type
          value: kubernetes.io/dockerconfigjson
      - equal:
          path: data['.dockerconfigjson']
          value: '{"auths":{"registry1.example.com/repo1":{"username":"username1","password":"password1","auth":"dXNlcm5hbWUxOnBhc3N3b3JkMQ=="}}}'
          decodeBase64: true
      - equal:
          path: data
          value:
            .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeTEuZXhhbXBsZS5jb20vcmVwbzEiOnsidXNlcm5hbWUiOiJ1c2VybmFtZTEiLCJwYXNzd29yZCI6InBhc3N3b3JkMSIsImF1dGgiOiJkWE5sY201aGJXVXhPbkJoYzNOM2IzSmtNUT09In19fQ==

  - it: should create the imagepullsecret with multiple credentials
    documentSelector:
      path: metadata.name
      value: release-name-pipeline-optimization-imagepullsecret
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
    asserts:
      - equal:
          path: data['.dockerconfigjson']
          value: '{"auths":{"registry1.example.com/repo1":{"username":"username1","password":"password1","auth":"dXNlcm5hbWUxOnBhc3N3b3JkMQ=="},"registry2.example.com/repo2":{"username":"username2","password":"password2","auth":"dXNlcm5hbWUyOnBhc3N3b3JkMg=="}}}'
          decodeBase64: true
      - matchSnapshot: {}

  - it: should apply commonLabels to Secret metadata
    set:
      commonLabels:
        team: platform
        environment: production
    asserts:
      - equal:
          path: metadata.labels.team
          value: platform
      - equal:
          path: metadata.labels.environment
          value: production

  - it: should apply commonAnnotations to Secret metadata
    set:
      commonAnnotations:
        example.com/annotation: "value"
    asserts:
      - equal:
          path: metadata.annotations["example.com/annotation"]
          value: "value"

  - it: should apply secretLabels to Secret metadata
    set:
      secretLabels:
        app.kubernetes.io/component: secret
        custom-label: custom-value
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: secret
      - equal:
          path: metadata.labels["custom-label"]
          value: custom-value

  - it: should apply secretAnnotations to Secret metadata
    set:
      secretAnnotations:
        secret.example.com/annotation: "secret-specific"
    asserts:
      - equal:
          path: metadata.annotations["secret.example.com/annotation"]
          value: "secret-specific"

  - it: should merge commonLabels and secretLabels
    set:
      database:
        password: "fixed-swell-password"
      platformDatabase:
        password: "fixed-platform-password"
      commonLabels:
        team: platform
        environment: production
      secretLabels:
        app.kubernetes.io/component: secret
        custom-label: custom-value
    asserts:
      - equal:
          path: metadata.labels.team
          value: platform
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: secret
      - equal:
          path: metadata.labels["custom-label"]
          value: custom-value
      - matchSnapshot: {}

  - it: should merge commonAnnotations and secretAnnotations
    set:
      database:
        password: "fixed-swell-password"
      platformDatabase:
        password: "fixed-platform-password"
      commonAnnotations:
        example.com/annotation: "common-value"
      secretAnnotations:
        secret.example.com/annotation: "secret-specific"
    asserts:
      - equal:
          path: metadata.annotations["example.com/annotation"]
          value: "common-value"
      - equal:
          path: metadata.annotations["secret.example.com/annotation"]
          value: "secret-specific"
      - matchSnapshot: {}

  - it: should allow secretLabels to override commonLabels
    set:
      commonLabels:
        app.kubernetes.io/component: common
      secretLabels:
        app.kubernetes.io/component: secret
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: secret

  - it: should evaluate template expressions in secretLabels
    set:
      database:
        password: "fixed-swell-password"
      platformDatabase:
        password: "fixed-platform-password"
      secretLabels:
        release: "{{ .Release.Name }}"
        chart: "{{ .Chart.Name }}"
    asserts:
      - equal:
          path: metadata.labels.release
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.chart
          value: "pipeline-optimization"
      - matchSnapshot: {}

  - it: should evaluate template expressions in secretAnnotations
    set:
      database:
        password: "fixed-swell-password"
      platformDatabase:
        password: "fixed-platform-password"
      secretAnnotations:
        release-name: "{{ .Release.Name }}"
        app-version: "{{ .Chart.AppVersion }}"
    asserts:
      - equal:
          path: metadata.annotations["release-name"]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.annotations["app-version"]
          value: "v9.9.9"
      - matchSnapshot: {}

  - it: should render annotations in all secrets when provided
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      commonAnnotations:
        annotation1: "value1"
        annotation2: "value2"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations
          value:
            annotation1: "value1"
            annotation2: "value2"

  - it: should render annotations in all secrets when provided via secretAnnotations
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      secretAnnotations:
        labelA: "valueA"
        annotationB: "valueB"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations
          value:
            labelA: "valueA"
            annotationB: "valueB"

  - it: should merge annotations from commonAnnotations and secretAnnotations
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      commonAnnotations:
        annotation1: "this should get overwritten"
        annotation2: "this should stay"
      secretAnnotations:
        annotation1: "this overrides the common annotation"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations
          value:
            annotation1: "this overrides the common annotation"
            annotation2: "this should stay"

  - it: should render labels in all secrets when provided
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      commonLabels:
        label1: "value1"
        label2: "value2"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.labels
          value:
            label1: "value1"
            label2: "value2"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: pipeline-optimization
            app.kubernetes.io/version: v9.9.9
            helm.sh/chart: pipeline-optimization-1.2.3

  - it: should render labels in all secrets when provided via secretLabels
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      secretLabels:
        labelA: "valueA"
        labelB: "valueB"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.labels
          value:
            labelA: "valueA"
            labelB: "valueB"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: pipeline-optimization
            app.kubernetes.io/version: v9.9.9
            helm.sh/chart: pipeline-optimization-1.2.3

  - it: should merge labels from commonLabels and secretLabels
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
      commonLabels:
        label1: "this should get overwritten"
        label2: "this should stay"
      secretLabels:
        label1: "this overrides the common annotation"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.labels
          value:
            label1: "this overrides the common annotation"
            label2: "this should stay"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: pipeline-optimization
            app.kubernetes.io/version: v9.9.9
            helm.sh/chart: pipeline-optimization-1.2.3

  - it: should use custom namespace when specified
    set:
      namespaceOverride: custom-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  - it: should use correct naming convention for Secret
    asserts:
      - equal:
          path: metadata.name
          value: release-name-pipeline-optimization
      - matchRegex:
          path: metadata.name
          pattern: ^release-name-pipeline-optimization$

  - it: should have correct apiVersion and kind
    asserts:
      - equal:
          path: apiVersion
          value: v1
      - isKind:
          of: Secret

  - it: should generate passwords when not provided
    set:
      database:
        password: ""
        existingSecretName: ""
      platformDatabase:
        password: ""
        existingSecretName: ""
    asserts:
      - matchRegex:
          path: data.SWELL_DB_PASSWORD
          pattern: "^[A-Za-z0-9]{10}$"
          decodeBase64: true
      - matchRegex:
          path: data.TOWER_DB_PASSWORD
          pattern: "^[A-Za-z0-9]{10}$"
          decodeBase64: true

  - it: should contain database passwords when configured
    set:
      database:
        password: "test-swell-password"
      platformDatabase:
        password: "test-platform-password"
    asserts:
      - isNotEmpty:
          path: data.SWELL_DB_PASSWORD
      - isNotEmpty:
          path: data.TOWER_DB_PASSWORD
      - equal:
          path: data.SWELL_DB_PASSWORD
          value: test-swell-password
          decodeBase64: true
      - equal:
          path: data.TOWER_DB_PASSWORD
          value: test-platform-password
          decodeBase64: true

  - it: should render complete secret with both passwords
    set:
      database:
        host: swelldb.example.com
        password: "swell-secret"
      platformDatabase:
        host: platformdb.example.com
        password: "platform-secret"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: data.SWELL_DB_PASSWORD
          value: "swell-secret"
          decodeBase64: true
      - equal:
          path: data.TOWER_DB_PASSWORD
          value: "platform-secret"
          decodeBase64: true
      - matchSnapshot: {}
