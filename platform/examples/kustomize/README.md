# Kustomize Integration Example for Seqera Platform Helm Chart

This directory contains a complete example of how to use the Seqera Platform Helm chart with
[Kustomize's](https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/)
`helmCharts` feature.

> [!CAUTION]
> **Critical: Auto-Generated Secrets Are Not Compatible with Kustomize**
>
> When using Kustomize with the Seqera Platform Helm chart, you **MUST** explicitly provide values
> for fields that would otherwise be auto-generated by Helm.
>
> **Why?** Kustomize cannot query the cluster to check if secrets already exist. If you rely on
> Helm's auto-generated random values, Kustomize will regenerate new random values on every upgrade,
> which may cause failures.
>
> See [values.yaml](values.yaml) for examples of how to set these values explicitly.

## Prerequisites

1. **kubectl** configured to access your cluster and with Kustomize support
2. **Helm** v3 (required by Kustomize for chart rendering)

## Quick Start

### 1. Configure Values

Edit [values.yaml](values.yaml) and **explicitly set required secrets and secrets that would otherwise be auto-generated by Helm**.

### 2. Preview Manifests

```bash
kubectl kustomize --enable-helm .
```

### 3. Deploy

Deploy the chart defined in `kustomization.yaml`:

```bash
kubectl apply -k .
```

## How It Works

The [kustomization.yaml](kustomization.yaml) file:
1. **Pulls the Helm chart** from OCI registry and renders it with your values
2. **Applies patches** to customize resources (see `patches/` directory)
3. **Adds additional resources** not included in the chart (see `additional-resources/`)

**Values hierarchy** (later overrides earlier):
1. Chart defaults → 2. Your `values.yaml` → 3. `valuesInline` in kustomization.yaml

## Customization Examples

This example includes:
- **Strategic merge patches**: Add sidecars, env vars, labels ([patches/backend-deployment-patch.yaml](patches/backend-deployment-patch.yaml))
- **JSON 6902 patches**: Modify specific values ([patches/backend-resources-patch.yaml](patches/backend-resources-patch.yaml))
- **Additional resources**: Add NetworkPolicy, etc. ([additional-resources/](additional-resources/))
- **ConfigMap generation**: From files in `config/`

## Multi-Environment Setup

Use Kustomize overlays for different environments:

```
kustomize/
├── base/                    # This directory
└── overlays/
    ├── dev/
    ├── staging/
    └── production/
```

Each overlay references the base and provides environment-specific values. See the [Kustomize documentation](https://kubectl.docs.kubernetes.io/references/kustomize/) for details.

## Resources

- [Kustomize Documentation](https://kubectl.docs.kubernetes.io/references/kustomize/)
- [Kustomize Helm Integration](https://kubectl.docs.kubernetes.io/references/kustomize/builtins/#helm-chart-inflation)
- [Seqera Platform Helm Chart](https://github.com/seqeralabs/helm-charts)
