{{/* We can't put checks in _helpers.tpl, it doesn't make installation fail. */}}

{{- if not .Values.global.platformDatabase.host -}}
{{- $message := "Define the MySQL database hostname at 'global.platformDatabase.host'." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{- if and (not .Values.redis.host) (not .Values.global.redis.host) -}}
{{- $message := "Define the Redis hostname in 'redis' or 'global.redis' ('redis' takes precedence over 'global.redis')" -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{- if and .Values.tower.smtp.host .Values.tower.awsSesEnable -}}
{{- $message := "Either define a SMTP server at tower.smtp.host, or enable AWS SES with tower.awsSesEnable, not both." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- if and .Values.tower.awsSesEnable (has "e2e" .Values.backend.micronautEnvironments) -}}
{{- $message := "The AWS SES provider is not compatible with the test environment, disable/drop either of them." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{/* Check that string and secret values are not passed together for jwt, crypto, metering and license. */}}
{{- if and .Values.tower.jwtSeedString .Values.tower.jwtSeedSecretName -}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the JWT seed or a secret name containing the key 'TOWER_JWT_SECRET' are needed, not both." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- if and .Values.tower.cryptoSeedString .Values.tower.cryptoSeedSecretName -}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the Crypto seed or a secret name containing the key 'TOWER_CRYPTO_SECRETKEY' are needed, not both." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- if and .Values.tower.metering.token .Values.tower.metering.existingSecret -}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the Metering seed or a secret name containing the key 'METERING_TOKEN' are needed, not both." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- if or (and .Values.tower.licenseString .Values.tower.licenseSecretName)
          (and (not .Values.tower.licenseString) (not .Values.tower.licenseSecretName) )
-}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the License or a secret name containing the key 'TOWER_LICENSE' are needed, but not both at the same time." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

Thank you for installing {{ .Chart.Name | title }}!

Your release is named '{{ .Release.Name }}' and was installed in the '{{ include "common.names.namespace" . }}' namespace.

To check the status of your release, try:

  $ helm --namespace {{ include "common.names.namespace" . }} status {{ .Release.Name }}
  $ helm --namespace {{ include "common.names.namespace" . }} get all {{ .Release.Name }}
