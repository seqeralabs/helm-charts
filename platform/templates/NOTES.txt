{{/* We can't put checks in _helpers.tpl, it doesn't make installation fail. */}}

{{- $addr := tpl (toString .Values.global.platformServiceAddress) . -}}
{{- if not $addr -}}
{{- $message := "Define the platform service address at 'global.platformServiceAddress'. It can be a template, but it cannot render to an empty value." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- else -}}
{{- $validationErrors := include "platform.validate.dnsLabel" (dict "value" $addr) -}}
{{- if $validationErrors -}}
{{- $message := printf "Invalid global.platformServiceAddress='%s' %s" $addr $validationErrors -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- end -}}

{{- $port := tpl (toString .Values.global.platformServicePort) . -}}
{{- if not $port -}}
{{- $message := "Define the platform service port at 'global.platformServicePort'. It can be a template, but it cannot render to an empty value." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- else -}}
{{- $validationErrors := include "platform.validate.isInteger" (dict "value" $port) -}}
{{- if $validationErrors -}}
{{- $message := printf "Invalid global.platformServicePort='%s' %s" (toString $port) $validationErrors -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- end -}}

{{- if not .Values.global.platformDatabase.host -}}
{{- $message := "Define the MySQL database hostname at 'global.platformDatabase.host'." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{- if and (not .Values.redis.host) (not .Values.global.redis.host) -}}
{{- $message := "Define the Redis hostname in 'redis' or 'global.redis' ('redis' takes precedence over 'global.redis')" -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{/* Check that string and secret values are not passed together for jwt, crypto and license. */}}
{{- if and .Values.platform.jwtSeedString .Values.platform.jwtSeedSecretName -}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the JWT seed at platform.jwtSeedString or a secret name at platform.jwtSeedSecretName are needed, not both." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- if and .Values.platform.cryptoSeedString .Values.platform.cryptoSeedSecretName -}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the Crypto seed at platform.cryptoSeedString or a secret name at platform.cryptoSeedSecretName are needed, not both." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}
{{- if or (and .Values.platform.licenseString .Values.platform.licenseSecretName)
          (and (not .Values.platform.licenseString) (not .Values.platform.licenseSecretName) )
-}}
{{- $messages := list -}}
{{- $messages := append $messages "Either a string version of the License at platform.licenseString or a secret name at platform.licenseSecretName are needed, not both." -}}
{{- $message := join "\n" $messages -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{- if and .Values.cron.dbMigrationInitContainer.args (not .Values.cron.dbMigrationInitContainer.command) -}}
{{- $message := "If 'cron.dbMigrationInitContainer.args' are provided, 'cron.dbMigrationInitContainer.command' must also be provided." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

{{- if not .Values.platform.executionBackends -}}
{{- $message := "At least one execution backend must be defined in 'platform.executionBackends'." -}}
{{- printf "\nVALUES VALIDATION:\n%s" $message | fail -}}
{{- end -}}

Thank you for installing {{ .Chart.Name | title }}!

Your release is named '{{ .Release.Name }}' and was installed in the '{{ include "common.names.namespace" . }}' namespace.

To check the status of your release, try:

  $ helm --namespace {{ include "common.names.namespace" . }} status {{ .Release.Name }}
  $ helm --namespace {{ include "common.names.namespace" . }} get all {{ .Release.Name }}

{{- if not .Values.platform.smtp.host -}}
NOTE: SMTP hostname not configured, email notifications may not be sent. You can set it up by providing the SMTP host and other parameters in the 'platform.smtp' section of the values.
If you're using AWS SES, refer to the documentation for the required settings: https://docs.seqera.io/platform-enterprise/enterprise/configuration/overview#aws-ses-integration
{{- end }}
