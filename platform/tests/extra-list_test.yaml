# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform extra objects
templates:
  - extra-list.yaml
tests:
  - it: should not render any extra objects when list is empty
    asserts:
      - hasDocuments:
          count: 0

  - it: should render single extra object when added to list
    set:
      extraDeploy:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: extra-configmap
          data:
            key1: value1
            key2: value2
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: extra-configmap
      - equal:
          path: data
          value:
            key1: value1
            key2: value2

  - it: should render multiple extra objects when added to list
    set:
      extraDeploy:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: extra-configmap
          data:
            key1: value1
            key2: value2
        - apiVersion: v1
          kind: Secret
          metadata:
            name: extra-secret
          stringData:
            password: mysecretpassword
    asserts:
      - isKind:
          of: ConfigMap
        documentSelector:
          path: kind
          value: ConfigMap
      - equal:
          path: metadata.name
          value: extra-configmap
        documentSelector:
          path: kind
          value: ConfigMap
      - equal:
          path: data
          value:
            key1: value1
            key2: value2
        documentSelector:
          path: kind
          value: ConfigMap

      - isKind:
          of: Secret
        documentSelector:
          path: kind
          value: Secret
      - equal:
          path: metadata.name
          value: extra-secret
        documentSelector:
          path: kind
          value: Secret
      - equal:
          path: stringData
          value:
            password: mysecretpassword
        documentSelector:
          path: kind
          value: Secret

  - it: should handle complex extra objects with templated rendering
    set:
      extraDeploy:
        - apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: extra-deployment
            labels:
              app: extra-app
              a-label-with-templated-value: "{{ .Values.global.platformServicePort | default 8443 }}"
            annotations:
              rendered-annotation: "{{ .Values.global.platformServicePort | default 8443 }}"
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: extra-app
            template:
              metadata:
                labels:
                  app: extra-app
                  a-label-with-templated-value: "{{ .Values.global.platformServicePort | default 8443 }}"
              spec:
                containers:
                  - name: extra-container
                    image: nginx:1.2.3
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: extra-deployment
      - equal:
          path: metadata.annotations
          value:
            rendered-annotation: "8080"
      - equal:
          path: metadata.labels
          value:
            app: extra-app
            a-label-with-templated-value: "8080"
      - equal:
          path: spec.selector.matchLabels
          value:
            app: extra-app
      - equal:
          path: .spec.template.metadata.labels
          value:
            app: extra-app
            a-label-with-templated-value: "8080"
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.template.spec.containers[0]
          value:
            name: extra-container
            image: nginx:1.2.3
