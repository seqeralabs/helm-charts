# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test Platform serviceaccount
templates:
  - serviceaccount.yaml
tests:
  - it: should render 1 serviceaccount by default
    chart:
      version: 9.9.9
      appVersion: v1.2.3+1234567890
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata
          value:
              name: release-name-platform-sa
              namespace: NAMESPACE
              labels:
                app.kubernetes.io/instance: RELEASE-NAME
                app.kubernetes.io/managed-by: Helm
                app.kubernetes.io/name: platform
                app.kubernetes.io/version: v1.2.3+1234567890
                helm.sh/chart: platform-9.9.9
      - equal:
          path: automountServiceAccountToken
          value: false
      - notExists:
          path: imagepullSecrets

  - it: should not render a serviceaccount if user provides a sa name
    set:
      serviceAccount:
        name: custom-service-account
    asserts:
      - hasDocuments:
          count: 0

  - it: should render a serviceaccount with names of image pull secret created by Helm
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-platform-imagepullsecret

  - it: should render a serviceaccount with names of image pull secret created by Helm + user provided
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
      serviceAccount:
        imagePullSecretNames:
          - custom-secret-1
          - custom-secret-2
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-platform-imagepullsecret
            - name: custom-secret-1
            - name: custom-secret-2

  - it: should enable automountServiceAccountToken when requested, string
    set:
      serviceAccount:
        automountServiceAccountToken: "true"
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should enable automountServiceAccountToken when requested, boolean
    set:
      serviceAccount:
        automountServiceAccountToken: true
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should render a serviceaccount with annotations from both common and serviceAccount
    set:
      commonAnnotations:
        common-annotation-key: common-annotation-value
      serviceAccount:
        annotations:
          sa-annotation-key: sa-annotation-value
    asserts:
      - equal:
          path: metadata.annotations
          value:
            common-annotation-key: common-annotation-value
            sa-annotation-key: sa-annotation-value

  - it: should render a serviceaccount with only common annotations
    set:
      commonAnnotations:
        common-annotation-key: common-annotation-value
      serviceAccount:
        annotations: {}
    asserts:
      - equal:
          path: metadata.annotations
          value:
            common-annotation-key: common-annotation-value

  - it: should render a serviceaccount with only serviceAccount annotations
    set:
      commonAnnotations: {}
      serviceAccount:
        annotations:
          sa-annotation-key: sa-annotation-value
    asserts:
      - equal:
          path: metadata.annotations
          value:
            sa-annotation-key: sa-annotation-value

  - it: should render a serviceaccount with labels from commonLabels
    chart:
      version: 9.9.9
      appVersion: v1.2.3+1234567890
    set:
      commonLabels:
        custom-label-key: custom-label-value
    asserts:
      - equal:
          path: metadata.labels
          value:
            custom-label-key: custom-label-value
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: platform
            app.kubernetes.io/version: v1.2.3+1234567890
            helm.sh/chart: platform-9.9.9
