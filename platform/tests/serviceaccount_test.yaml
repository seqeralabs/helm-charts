# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 - 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform serviceaccount
templates:
  - serviceaccount.yaml
tests:
  - it: should render 1 serviceaccount by default
    chart:
      version: 9.9.9
      appVersion: v1.2.3+1234567890
    asserts:
      - matchSnapshot: {}

  - it: should not render a serviceaccount if user provides an existing service account by name
    set:
      serviceAccount:
        name: custom-service-account
    asserts:
      - hasDocuments:
          count: 0

  - it: should render a serviceaccount with names of image pull secret created by Helm
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-platform-imagepullsecret

  - it: should render a serviceaccount with names of image pull secret created by Helm + user provided
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
      serviceAccount:
        imagePullSecretNames:
          - custom-secret-1
          - custom-secret-2
    asserts:
      - equal:
          path: imagePullSecrets
          value:
            - name: release-name-platform-imagepullsecret
            - name: custom-secret-1
            - name: custom-secret-2

  - it: should enable automountServiceAccountToken when requested, string
    set:
      serviceAccount:
        automountServiceAccountToken: "true"
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should enable automountServiceAccountToken when requested, boolean
    set:
      serviceAccount:
        automountServiceAccountToken: true
    asserts:
      - equal:
          path: automountServiceAccountToken
          value: true

  - it: should render a serviceaccount with only common annotations
    set:
      commonAnnotations:
        common-annotation-key: common-annotation-value
        templated-annotation-key: "{{ .Values.global.platformServicePort | default 8441 }}"
      serviceAccount:
        annotations: {}
    asserts:
      - equal:
          path: metadata.annotations
          value:
            common-annotation-key: common-annotation-value
            templated-annotation-key: "8080"

  - it: should render a serviceaccount with only serviceAccount annotations
    set:
      commonAnnotations: {}
      serviceAccount:
        annotations:
          sa-annotation-key: sa-annotation-value
          templated-annotation-key: "{{ .Values.global.platformServicePort | default 8441 }}"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            sa-annotation-key: sa-annotation-value
            templated-annotation-key: "8080"

  - it: should render a serviceaccount with annotations from both common and serviceAccount
    set:
      commonAnnotations:
        common-annotation-key: common-annotation-value
        annotation-to-override: "this-will-be-overridden"
        templated-annotation-key: "{{ .Values.global.platformServicePort | default 8441 }}"
      serviceAccount:
        annotations:
          sa-annotation-key: sa-annotation-value
          annotation-to-override: "this-overrides-the-commonAnnotations"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            common-annotation-key: common-annotation-value
            annotation-to-override: "this-overrides-the-commonAnnotations"
            sa-annotation-key: sa-annotation-value
            templated-annotation-key: "8080"

  - it: should render a serviceaccount with labels from commonLabels
    chart:
      version: 9.9.9
      appVersion: v1.2.3+1234567890
    set:
      commonLabels:
        custom-label-key: custom-label-value
        templated-label-key: "{{ .Values.global.platformServicePort | default 8441 }}"
    asserts:
      - equal:
          path: metadata.labels
          value:
            custom-label-key: custom-label-value
            templated-label-key: "8080"
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: platform
            app.kubernetes.io/version: v1.2.3+1234567890
            helm.sh/chart: platform-9.9.9
