# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test Platform backend deployment
templates:
  - deployment-backend.yaml
  - secret.yaml
  - configmap.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
  - it: should produce a Deployment resource with minimal values
    # We need to set the template name because we needed to include the secret and configmap files
    # to compute their checksums that are added to the deployment annotations to perform automatic
    # rollouts, but we aren't interested in testing those files here.
    template: deployment-backend.yaml
    set:
      redis:
        host: "asdf"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: release-name-platform-backend
      - equal:
          path: spec.template.spec
          value:
            containers:
              - env:
                  - name: NXF_HOME
                    value: /var/cache/tower/
                  - name: NXF_PLUGINS_DIR
                    value: /var/cache/tower/plugins/
                envFrom:
                  - configMapRef:
                      name: release-name-platform-backend
                  - configMapRef:
                      name: release-name-platform-shared-backend-cron
                  - secretRef:
                      name: release-name-platform-backend
                image: cr.seqera.io/private/nf-tower-enterprise/backend:v9.9.9
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 10
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 5
                  periodSeconds: 10
                  successThreshold: 1
                  timeoutSeconds: 3
                name: backend
                readinessProbe:
                  failureThreshold: 5
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  successThreshold: 1
                  timeoutSeconds: 3
                securityContext:
                  capabilities:
                    drop:
                      - ALL
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 101
                volumeMounts:
                  - mountPath: /tower.yml
                    name: config-volume
                    subPath: tower.yml
                  - mountPath: /var/cache/tower/
                    name: plugin-volume
                  - mountPath: /.nextflow/
                    name: plugin-volume
                  - mountPath: /?/.nextflow/
                    name: plugin-volume
            initContainers:
              - command:
                  - sh
                  - -c
                  - |
                    echo "$(date): starting check for db $DB_HOST:$DB_PORT"
                    until mysql -h "$DB_HOST" -P "$DB_PORT" -D "$DB_NAME" -u"$DB_USERNAME" -p"$TOWER_DB_PASSWORD" -e "SELECT VERSION()"; do
                      echo "$(date): see you in $SLEEP_PERIOD_SECONDS seconds"
                      sleep $SLEEP_PERIOD_SECONDS
                    done
                    echo "$(date): db server ready"
                env:
                  - name: SLEEP_PERIOD_SECONDS
                    value: "5"
                  - name: DB_HOST
                    value: ""
                  - name: DB_PORT
                    value: "3306"
                  - name: DB_NAME
                    value: null
                  - name: DB_USERNAME
                    value: ""
                envFrom:
                  - secretRef:
                      name: release-name-platform-backend
                image: mysql:9
                imagePullPolicy: IfNotPresent
                name: wait-for-db
                resources:
                  limits:
                    memory: 100Mi
                  requests:
                    cpu: "0.5"
                    memory: 50Mi
                securityContext:
                  capabilities:
                    drop:
                      - ALL
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 101
              - command:
                  - sh
                  - -c
                  - |
                    echo "$(date): starting check redis host '$REDIS_URI' with password (if set) '$REDISCLI_AUTH'";
                    until redis-cli -u "$REDIS_URI" get hello; do
                      echo "$(date): see you in $SLEEP_PERIOD_SECONDS seconds"
                      sleep $SLEEP_PERIOD_SECONDS
                    done
                    echo "$(date): redis server ready"
                env:
                  - name: SLEEP_PERIOD_SECONDS
                    value: "5"
                  - name: REDIS_URI
                    value: redis://asdf:6379
                image: redis:7
                imagePullPolicy: IfNotPresent
                name: wait-for-redis
                resources:
                  limits:
                    memory: 100Mi
                  requests:
                    cpu: "0.5"
                    memory: 50Mi
                securityContext:
                  capabilities:
                    drop:
                      - ALL
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 101
              - command:
                  - sh
                  - -c
                  - |
                    echo "$(date): starting check for cron to be ready at \"${CRON_HOST}:${CRON_PORT}/health\""
                    until curl -s ${CRON_HOST}:${CRON_PORT}/health |grep -q \"UP\"; do
                      echo "$(date): see you in $SLEEP_PERIOD_SECONDS seconds"
                      sleep $SLEEP_PERIOD_SECONDS
                    done
                    echo "$(date): cron ready"
                env:
                  - name: SLEEP_PERIOD_SECONDS
                    value: "5"
                  - name: CRON_HOST
                    value: release-name-platform-cron
                  - name: CRON_PORT
                    value: "8080"
                image: curlimages/curl:latest
                imagePullPolicy: IfNotPresent
                name: wait-for-cron
                resources:
                  limits:
                    memory: 100Mi
                  requests:
                    cpu: "0.5"
                    memory: 50Mi
                securityContext:
                  capabilities:
                    drop:
                      - ALL
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 101
            securityContext:
              fsGroup: 101
            serviceAccountName: release-name-platform-sa
            volumes:
              - configMap:
                  name: release-name-platform-tower-yml
                name: config-volume
              - emptyDir:
                  sizeLimit: 1Gi
                name: plugin-volume

  - it: should render the backend deployment with the specified tag version
    template: deployment-backend.yaml
    set:
      backend:
        image:
          tag: "9.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "cr.seqera.io/private/nf-tower-enterprise/backend:9.0.0"

  - it: should render the backend deployment with the specified digest, overriding the tag
    template: deployment-backend.yaml
    set:
      backend:
        image:
          tag: "this will be ignored"
          digest: "sha256:1234abcdef"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "cr.seqera.io/private/nf-tower-enterprise/backend@sha256:1234abcdef"

  - it: should render the backend deployment with the correct checksums, labels and annotations
    template: deployment-backend.yaml
    # the chart version is included in the annotations, so it needs to be set
    chart:
      version: "9.9.9+test"
      appVersion: "9.9.9"
    kubernetesProvider:
      scheme:
        "v1/Secret":
          gvr:
            version:  "v1"
            resource: "secrets"
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            name: unittest
            namespace: NAMESPACE
          data:
            db-password-key: "bXktZGItcGFzc3dvcmQxMjM=" # my-db-password123
            license-token-key: "bXktcGxhdGZvcm0tbGljZW5zZTEyMw==" # my-platform-license123
    set:
      global:
        platformDatabase:
          existingSecretName: "unittest"
          existingSecretKey: "db-password-key"
      commonLabels:
        key123: this-should-be-overridden-in-pod-labels
        key456: this-should-not-be-overridden
        key789: "{{ .Values.global.platformServicePort | default 8443 }}"
      commonAnnotations:
        common-annotation-key: common-annotation-value
      backend:
        podLabels:
          key123: this-overrides-the-commonLabels
        podAnnotations:
          pod-annotation-key: pod-annotation-value
          pod-annotation-key2: "{{ .Values.global.platformServicePort | default 8443 }}"
      platform:
        jwtSeedString: these need to be defined
        cryptoSeedString: otherwise 'helm template' creates random ones each time
        # Take the license from a secret instead of a string, just for fun
        licenseSecretName: "unittest"
        licenseSecretKey: "license-token-key"
    asserts:
      - matchSnapshot: {}

  - it: shouldn't obey custom selector requests
    template: deployment-backend.yaml
    set:
      backend:
        extraOptionsSpec:
          selector:
            matchLabels:
              app: something-else
    asserts:
      - equal:
          path: spec.selector.matchLabels
          value:
            app: backend
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: platform

  - it: should obey a mix of ignored fields and valid options in extraOptionsSpec
    template: deployment-backend.yaml
    set:
      backend:
        extraOptionsSpec:
          replicas: 3
          selector:
            matchLabels:
              app: something-else
          revisionHistoryLimit: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3
      - equal:
          path: spec.revisionHistoryLimit
          value: 3
      - equal:
          path: spec.selector.matchLabels
          value:
            app: backend
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: platform

  - it: should render extraOptionsTemplateSpec under spec.template.spec
    template: deployment-backend.yaml
    set:
      backend:
        extraOptionsTemplateSpec:
          nodeSelector:
            disktype: ssd
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: app
                        operator: In
                        values:
                          - whatever
                  topologyKey: "kubernetes.io/hostname"
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            disktype: ssd
      - equal:
          path: spec.template.spec.affinity
          value:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: app
                        operator: In
                        values:
                          - whatever
                  topologyKey: "kubernetes.io/hostname"

  - it: should ignore certain fields that we manage under extraOptionsTemplateSpec
    template: deployment-backend.yaml
    set:
      backend:
        extraOptionsTemplateSpec:
          serviceAccountName: "some-other-sa"
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: release-name-platform-sa

  - it: should ignore certain managed fields under extraOptionsTemplateSpec and still render others
    template: deployment-backend.yaml
    set:
      backend:
        extraOptionsTemplateSpec:
          serviceAccountName: "some-other-sa"
          dnsPolicy: ClusterFirstWithHostNet
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: release-name-platform-sa
      - equal:
          path: spec.template.spec.dnsPolicy
          value: ClusterFirstWithHostNet

  - it: should render default podsecurityContext
    template: deployment-backend.yaml
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 101

  - it: should disable podSecurityContext when 'enabled' is false
    template: deployment-backend.yaml
    set:
      backend:
        podSecurityContext:
          enabled: false
    asserts:
      - notExists:
          path: spec.template.spec.securityContext

  - it: should prevent podSecurityContext to be set via extraOptionsTemplateSpec when 'enabled' is false
    template: deployment-backend.yaml
    set:
      backend:
        podSecurityContext:
          enabled: false
        extraOptionsTemplateSpec:
          securityContext:
            fsGroup: 2000
    asserts:
      - notExists:
          path: spec.template.spec.securityContext

  - it: should omit the 'enabled' field from podSecurityContext
    template: deployment-backend.yaml
    set:
      backend:
        podSecurityContext:
          enabled: true
    asserts:
      - notExists:
          path: spec.template.spec.securityContext.enabled
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 101

  - it: should render whatever podsecurityContext is set
    template: deployment-backend.yaml
    set:
      backend:
        podSecurityContext:
          enabled: true
          fsGroup: 2000
          asdf: 123
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            fsGroup: 2000
            asdf: 123

  - it: should render custom container securityContext
    template: deployment-backend.yaml
    set:
      backend:
        containerSecurityContext:
          capabilities:
            add:
              - NET_ADMIN
          runAsUser: 2000
          runAsNonRoot: false
          readOnlyRootFilesystem: false
          asdf: 123
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            capabilities:
              add:
                - NET_ADMIN
              drop:
                - ALL
            readOnlyRootFilesystem: false
            runAsNonRoot: false
            runAsUser: 2000
            asdf: 123

  - it: should render container with extraEnvVars, extraEnvVarsCMs and extraEnvVarsSecrets
    template: deployment-backend.yaml
    set:
      backend:
        extraEnvVars:
          - name: CUSTOM_ENV_VAR
            value: custom-value
        extraEnvVarsCMs: [extra-env-vars-cm1, extra-env-vars-cm2]
        extraEnvVarsSecrets: [extra-env-vars-secret1, extra-env-vars-secret2]
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: NXF_HOME
              value: /var/cache/tower/
            - name: NXF_PLUGINS_DIR
              value: /var/cache/tower/plugins/
            - name: CUSTOM_ENV_VAR
              value: custom-value
      - equal:
          path: spec.template.spec.containers[0].envFrom
          value:
            - configMapRef:
                name: release-name-platform-backend
            - configMapRef:
                name: release-name-platform-shared-backend-cron
            - secretRef:
                name: release-name-platform-backend
            - configMapRef:
                name: extra-env-vars-cm1
            - configMapRef:
                name: extra-env-vars-cm2
            - secretRef:
                name: extra-env-vars-secret1
            - secretRef:
                name: extra-env-vars-secret2

  - it: should render initContainers that wait for required services to be ready
    template: deployment-backend.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 3
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-db
      - equal:
          path: spec.template.spec.initContainers[1].name
          value: wait-for-redis
      - equal:
          path: spec.template.spec.initContainers[2].name
          value: wait-for-cron
      - equal:
          path: spec.template.spec.initContainers[2].image
          value: curlimages/curl:latest
      - equal:
          path: spec.template.spec.initContainers[0].env
          value:
            - name: SLEEP_PERIOD_SECONDS
              value: "5"
            - name: DB_HOST
              value: ""
            - name: DB_PORT
              value: "3306"
            - name: DB_NAME
              value: null
            - name: DB_USERNAME
              value: ""
      - equal:
          path: spec.template.spec.initContainers[0].envFrom
          value:
            - secretRef:
                name: release-name-platform-backend
      - equal:
          path: spec.template.spec.initContainers[1].env
          value:
            - name: SLEEP_PERIOD_SECONDS
              value: "5"
            - name: REDIS_URI
              value: redis://:6379
      - equal:
          path: spec.template.spec.initContainers[2].env
          value:
            - name: SLEEP_PERIOD_SECONDS
              value: "5"
            - name: CRON_HOST
              value: release-name-platform-cron
            - name: CRON_PORT
              value: "8080"

  - it: should render initContainer with appropriate env vars
    template: deployment-backend.yaml
    kubernetesProvider:
      scheme:
        "v1/Secret":
          gvr:
            version:  "v1"
            resource: "secrets"
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            name: my-db-secret
            namespace: NAMESPACE
          data:
            my-db-password-key: "bXktZGItcGFzc3dvcmQxMjM=" # my-db-password123
    set:
      global:
        platformDatabase:
          host: "my-db-host"
          port: 3307
          name: "my-db-name"
          username: "my-db-username"
          existingSecretName: "my-db-secret"
          existingSecretKey: "my-db-password-key"
        redis:
          host: "my-redis-host"
          port: 6380
          password: "my-redis-password123"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].env
          value:
            - name: SLEEP_PERIOD_SECONDS
              value: "5"
            - name: DB_HOST
              value: my-db-host
            - name: DB_PORT
              value: "3307"
            - name: DB_NAME
              value: my-db-name
            - name: DB_USERNAME
              value: my-db-username
      - equal:
          path: spec.template.spec.initContainers[1].env
          value:
            - name: SLEEP_PERIOD_SECONDS
              value: "5"
            - name: REDIS_URI
              value: redis://my-redis-host:6379
            - name: REDISCLI_AUTH
              valueFrom:
                secretKeyRef:
                  name: release-name-platform-backend
                  key: TOWER_REDIS_PASSWORD
      - equal:
          path: spec.template.spec.initContainers[2].env
          value:
            - name: SLEEP_PERIOD_SECONDS
              value: "5"
            - name: CRON_HOST
              value: release-name-platform-cron
            - name: CRON_PORT
              value: "8080"
      - notExists:
          path: spec.template.spec.initContainers[2].envFrom

  - it: should render extra initContainer
    template: deployment-backend.yaml
    set:
      backend:
        initContainers:
          - name: extra-init-container
            image: busybox:latest
            command: ["sh", "-c", "echo Hello from extra init container"]
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 4
      - equal:
          path: spec.template.spec.initContainers[3]
          value:
            name: extra-init-container
            image: busybox:latest
            command: ["sh", "-c", "echo Hello from extra init container"]

  - it: should render multiple extra initContainers
    template: deployment-backend.yaml
    set:
      backend:
        initContainers:
          - name: extra-init-container1
            image: busybox:latest
            command: ["sh", "-c", "echo Hello from extra init container"]
          - name: extra-init-container2
            image: alpine:latest
            command: ["sh", "-c", "echo Hello from another extra init container"]
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 5
      - equal:
          path: spec.template.spec.initContainers[3]
          value:
            name: extra-init-container1
            image: busybox:latest
            command: ["sh", "-c", "echo Hello from extra init container"]
      - equal:
          path: spec.template.spec.initContainers[4]
          value:
            name: extra-init-container2
            image: alpine:latest
            command: ["sh", "-c", "echo Hello from another extra init container"]

  - it: should include extra volumeMounts in the backendcontainer
    template: deployment-backend.yaml
    set:
      backend:
        extraVolumeMounts:
          - name: extra-volume
            mountPath: /extra/path
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts
          value:
            - name: extra-volume
              mountPath: /extra/path
            - mountPath: /tower.yml
              name: config-volume
              subPath: tower.yml
            - mountPath: /var/cache/tower/
              name: plugin-volume
            - mountPath: /.nextflow/
              name: plugin-volume
            - mountPath: /?/.nextflow/
              name: plugin-volume

  - it: should include extra Volumes in the backend pod spec
    template: deployment-backend.yaml
    set:
      backend:
        extraVolumes:
          - name: extra-volume
            emptyDir: {}
    asserts:
      - equal:
          path: spec.template.spec.volumes
          value:
            - emptyDir: {}
              name: extra-volume
            - configMap:
                name: release-name-platform-tower-yml
              name: config-volume
            - emptyDir:
                sizeLimit: 1Gi
              name: plugin-volume

  - it: should use custom image for the backend deployment
    template: deployment-backend.yaml
    set:
      backend:
        image:
          registry: my-custom-registry.io
          repository: my-custom-repo/my-backend-image
          tag: "2.0.0"
          pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "my-custom-registry.io/my-custom-repo/my-backend-image:2.0.0"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  - it: should use custom image digest for the backend deployment
    template: deployment-backend.yaml
    set:
      backend:
        image:
          registry: my-custom-registry.io
          repository: my-custom-repo/my-backend-image
          tag: "this-will-be-ignored"
          digest: "sha256:whatever"
          pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "my-custom-registry.io/my-custom-repo/my-backend-image@sha256:whatever"

  - it: should use custom command and args for the backend container
    template: deployment-backend.yaml
    set:
      backend:
        command: ["/bin/custom-backend-start"]
        args: ["--custom-arg1", "value1"]
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/bin/custom-backend-start"]
      - equal:
          path: spec.template.spec.containers[0].args
          value: ["--custom-arg1", "value1"]

  - it: should render custom resources for the backend container
    template: deployment-backend.yaml
    set:
      backend:
        resources:
          limits:
            memory: 1Gi
          requests:
            cpu: "1"
            memory: 512Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              memory: 1Gi
            requests:
              cpu: "1"
              memory: 512Mi

  - it: should disable probes for the backend container
    template: deployment-backend.yaml
    set:
      backend:
        livenessProbe:
          enabled: false
        readinessProbe:
          enabled: false
    asserts:
      - notExists:
          path: spec.template.spec.containers[0].livenessProbe
      - notExists:
          path: spec.template.spec.containers[0].readinessProbe
      - notExists:
          path: spec.template.spec.containers[0].startupProbe

  - it: should use custom probe settings for the backend container
    template: deployment-backend.yaml
    set:
      backend:
        livenessProbe:
          initialDelaySeconds: 10
          periodSeconds: 20
        readinessProbe:
          initialDelaySeconds: 15
          periodSeconds: 25
        startupProbe:
          enabled: true
          initialDelaySeconds: 20
          periodSeconds: 30
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe
          value:
            failureThreshold: 5
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 3
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            failureThreshold: 10
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 20
            successThreshold: 1
            timeoutSeconds: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            failureThreshold: 5
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 25
            successThreshold: 1
            timeoutSeconds: 3

  - it: should use custom probe settings for the backend container with ports as templates
    template: deployment-backend.yaml
    set:
      backend:
        service:
          port:  "8089"
        livenessProbe:
          enabled: true
          httpGet:
            path: /health
            port: "{{ .Values.backend.service.port }}"
          initialDelaySeconds: 10
          periodSeconds: 20
        readinessProbe:
          enabled: true
          httpGet:
            path: /health
            port: "{{ .Values.backend.service.port }}"
          initialDelaySeconds: 15
          periodSeconds: 25
        startupProbe:
          enabled: true
          httpGet:
            path: /health
            port: "{{ .Values.backend.service.port }}"
          initialDelaySeconds: 20
          periodSeconds: 30
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe
          value:
            failureThreshold: 5
            httpGet:
              path: /health
              port: 8089
            initialDelaySeconds: 20
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 3
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            failureThreshold: 10
            httpGet:
              path: /health
              port: 8089
            initialDelaySeconds: 10
            periodSeconds: 20
            successThreshold: 1
            timeoutSeconds: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            failureThreshold: 5
            httpGet:
              path: /health
              port: 8089
            initialDelaySeconds: 15
            periodSeconds: 25
            successThreshold: 1
            timeoutSeconds: 3

  - it: should use custom probe settings for the backend container with some ports as templates, some string, some integer
    template: deployment-backend.yaml
    set:
      backend:
        service:
          port:  "8089"
        livenessProbe:
          enabled: true
          httpGet:
            path: /health
            port: "{{ .Values.backend.service.port }}"
        readinessProbe:
          enabled: true
          httpGet:
            path: /health
            port: "8088"
        startupProbe:
          enabled: true
          httpGet:
            path: /health
            port: 8087
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe
          value:
            failureThreshold: 5
            httpGet:
              path: /health
              port: 8087
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 3
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            failureThreshold: 10
            httpGet:
              path: /health
              port: 8089
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            failureThreshold: 5
            httpGet:
              path: /health
              port: 8088
            initialDelaySeconds: 5
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3

  - it: should add image pull secrets to the backend deployment
    template: deployment-backend.yaml
    set:
      backend:
        image:
          pullSecrets:
            - my-custom-pull-secret
            - my-custom-pull-secret2
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: my-custom-pull-secret
            - name: my-custom-pull-secret2

  - it: should render a templated integer value as integer
    template: deployment-backend.yaml
    set:
      frontend:
        extraOptionsSpec:
          replicas: 2
      backend:
        extraOptionsSpec:
          replicas: '{{ .Values.frontend.extraOptionsSpec.replicas }}'
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should disable initContainers that wait for required services to be ready
    template: deployment-backend.yaml
    set:
      initContainerDependencies:
        enabled: false
    asserts:
      - equal:
          path: spec.template.spec.initContainers
          value: null
