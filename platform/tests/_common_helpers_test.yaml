# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test Platform common templates
templates:
  - secret.yaml
  - deployment-cron.yaml
  - configmap.yaml # needed for checksum tests in deployments
tests:
  - it: should create the credentials in the imagepullsecret Secret correctly (duplicate of test in secret_test.yaml)
    template: secret.yaml
    documentSelector:
      path: metadata.name
      value: release-name-platform-imagepullsecret
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
    asserts:
      - equal:
          path: data['.dockerconfigjson']
          value: '{"auths":{"registry1.example.com/repo1":{"username":"username1","password":"password1","auth":"dXNlcm5hbWUxOnBhc3N3b3JkMQ=="},"registry2.example.com/repo2":{"username":"username2","password":"password2","auth":"dXNlcm5hbWUyOnBhc3N3b3JkMg=="}}}'
          decodeBase64: true
      - equal:
          path: data
          value:
            .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeTEuZXhhbXBsZS5jb20vcmVwbzEiOnsidXNlcm5hbWUiOiJ1c2VybmFtZTEiLCJwYXNzd29yZCI6InBhc3N3b3JkMSIsImF1dGgiOiJkWE5sY201aGJXVXhPbkJoYzNOM2IzSmtNUT09In0sInJlZ2lzdHJ5Mi5leGFtcGxlLmNvbS9yZXBvMiI6eyJ1c2VybmFtZSI6InVzZXJuYW1lMiIsInBhc3N3b3JkIjoicGFzc3dvcmQyIiwiYXV0aCI6ImRYTmxjbTVoYldVeU9uQmhjM04zYjNKa01nPT0ifX19

  - it: should use render httpGet port as integer correctly in cron deployment probes
    template: deployment-cron.yaml
    set:
      cron:
        service:
          http:
            port: 8081
        livenessProbe:
          enabled: true
          httpGet:
            path: /health
            port: "{{ .Values.cron.service.http.port }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8081

  - it: should merge configMapAnnotations and commonAnnotations correctly in configmaps, rendering numbers as integers
    template: configmap.yaml
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      global:
        platformServicePort: 8443
      tower:
        configMapAnnotations:
          annotation1: "value1"
          annotation2: "{{ .Values.global.platformServicePort }}"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            annotation1: "value1"
            annotation2: 8443

  - it: should render standard labels with seqera.labels.standard rendering numbers as integers
    template: deployment-cron.yaml
    set:
      global:
        platformServicePort: 8080
      commonLabels:
        custom.label/port: "{{ .Values.global.platformServicePort }}"
        custom.label/version: "1.2.3"
        custom.label/replica-count: "3"
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: platform
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            custom.label/port: 8080
            custom.label/version: "1.2.3"
            custom.label/replica-count: 3

  - it: should render standard labels without customLabels
    template: deployment-cron.yaml
    set:
      commonLabels: {}
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: platform
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm

  - it: should render standard labels with template evaluation
    template: deployment-cron.yaml
    set:
      global:
        customValue: "custom-value"
      commonLabels:
        templated-label: "{{ .Values.global.customValue }}"
        numeric-label: "9000"
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            templated-label: "custom-value"
            numeric-label: 9000
