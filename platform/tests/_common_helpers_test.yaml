# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform common templates
templates:
  - secret.yaml
  - deployment-cron.yaml
  - configmap.yaml # needed for checksum tests in deployments
tests:
  - it: should create the credentials in the imagepullsecret Secret correctly (duplicate of test in secret_test.yaml)
    template: secret.yaml
    documentSelector:
      path: metadata.name
      value: release-name-platform-imagepullsecret
    set:
      global:
        imageCredentials:
          - registry: "registry1.example.com/repo1"
            username: "username1"
            password: "password1"
          - registry: "registry2.example.com/repo2"
            username: "username2"
            password: "password2"
    asserts:
      - equal:
          path: data['.dockerconfigjson']
          value: '{"auths":{"registry1.example.com/repo1":{"username":"username1","password":"password1","auth":"dXNlcm5hbWUxOnBhc3N3b3JkMQ=="},"registry2.example.com/repo2":{"username":"username2","password":"password2","auth":"dXNlcm5hbWUyOnBhc3N3b3JkMg=="}}}'
          decodeBase64: true
      - equal:
          path: data
          value:
            .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeTEuZXhhbXBsZS5jb20vcmVwbzEiOnsidXNlcm5hbWUiOiJ1c2VybmFtZTEiLCJwYXNzd29yZCI6InBhc3N3b3JkMSIsImF1dGgiOiJkWE5sY201aGJXVXhPbkJoYzNOM2IzSmtNUT09In0sInJlZ2lzdHJ5Mi5leGFtcGxlLmNvbS9yZXBvMiI6eyJ1c2VybmFtZSI6InVzZXJuYW1lMiIsInBhc3N3b3JkIjoicGFzc3dvcmQyIiwiYXV0aCI6ImRYTmxjbTVoYldVeU9uQmhjM04zYjNKa01nPT0ifX19

  - it: should use render httpGet port as integer correctly in cron deployment probes
    template: deployment-cron.yaml
    set:
      cron:
        service:
          http:
            port: 8081
        livenessProbe:
          enabled: true
          httpGet:
            path: /health
            port: "{{ .Values.cron.service.http.port }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8081
