# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test secret
templates:
  - secret.yaml
tests:
  - it: should render backend secret with default values
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: release-name-platform-backend
      - equal:
          path: type
          value: Opaque

  - it: should apply common labels
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      commonLabels:
        environment: "dev"
        team: "platform"
    asserts:
      - equal:
          path: metadata.labels.environment
          value: dev
      - equal:
          path: metadata.labels.team
          value: platform

  - it: should include JWT secret when not using external secret
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        jwtSeedSecretName: ""
        jwtSeedString: "my-jwt-seed"
    asserts:
      - equal:
          path: data.TOWER_JWT_SECRET
          value: my-jwt-seed
          decodeBase64: true

  - it: should include crypto secret when not using external secret
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        cryptoSeedSecretName: ""
        cryptoSeedString: "my-crypto-seed"
    asserts:
      - equal:
          path: data.TOWER_CRYPTO_SECRETKEY
          value: my-crypto-seed
          decodeBase64: true

  - it: should include license when not using external secret
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        licenseString: "my-license-key"
    asserts:
      - equal:
          path: data.TOWER_LICENSE
          value: my-license-key
          decodeBase64: true

  - it: should include SMTP configuration when configured
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        smtp:
          host: "smtp.example.com"
          port: "587"
          user: "user@example.com"
          password: "smtp-password"
    asserts:
      - equal:
          path: data.TOWER_SMTP_HOST
          value: smtp.example.com
          decodeBase64: true
      - equal:
          path: data.TOWER_SMTP_PORT
          value: "587"
          decodeBase64: true
      - equal:
          path: data.TOWER_SMTP_USER
          value: user@example.com
          decodeBase64: true
      - equal:
          path: data.TOWER_SMTP_PASSWORD
          value: smtp-password
          decodeBase64: true

  - it: should include AWS SES configuration when enabled
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        awsSesEnable: true
    asserts:
      - equal:
          path: data.TOWER_ENABLE_AWS_SES
          value: "true"
          decodeBase64: true

  - it: should include metering token when configured
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        metering:
          platformId: "platform-123"
          existingSecret: ""
          token: "metering-token"
    asserts:
      - isNotEmpty:
          path: data.METERING_METRONOME_TOKEN

  - it: should not include metering token when using external secret
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        metering:
          platformId: "platform-123"
          existingSecret: "external-metering-secret"
    asserts:
      - isNull:
          path: data.METERING_METRONOME_TOKEN

  - it: should include studio templates configuration
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      tower:
        studio:
          templates:
            template1:
              name: "Template 1"
              description: "First template"
            template2:
              name: "Template 2"
              description: "Second template"
    asserts:
      - isNotEmpty:
          path: data.TOWER_DATA_STUDIO_TEMPLATES_TEMPLATE1_NAME
      - isNotEmpty:
          path: data.TOWER_DATA_STUDIO_TEMPLATES_TEMPLATE1_DESCRIPTION
