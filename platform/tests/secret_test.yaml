# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 - 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform secret
templates:
  - secret.yaml
chart:
  version: 9.8.7
  appVersion: 1.2.3-asdf
# To avoid expensive RSA key generation in tests, we set a default oidcPrivateKeyBase64 value.
# Tests can override this if they need to test key generation specifically.
set:
  platform:
    oidcPrivateKeyBase64: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlCb3dJQkFBS0JBUUVBMQ=="
tests:
- it: should render 1 secret by default, when no pull credentials are provided
  asserts:
  - hasDocuments:
      count: 1
- it: should apply common labels
  set:
    commonLabels:
      environment: dev
      team: platform
  asserts:
  - equal:
      path: metadata.labels.environment
      value: dev
  - equal:
      path: metadata.labels.team
      value: platform
- it: should not fetch the Redis password from existing secret because we mount the user-provided secret on the pod directly
  set:
    redis:
      existingSecretName: unittest
  asserts:
  - notExists:
      path: data.TOWER_REDIS_PASSWORD
- it: should not fetch the JWT token from existing secret because we mount the user-provided secret on the pod directly
  set:
    platform:
      jwtSeedSecretName: unittest
  asserts:
  - notExists:
      path: data.TOWER_JWT_SECRET
- it: should not fetch the crypto token from existing secret because we mount the user-provided secret on the pod directly
  set:
    platform:
      cryptoSeedSecretName: unittest
  asserts:
  - notExists:
      path: data.TOWER_CRYPTO_SECRETKEY
- it: should not fetch the license token from existing secret because we mount the user-provided secret on the pod directly
  set:
    platform:
      licenseSecretName: unittest
  asserts:
  - notExists:
      path: data.TOWER_LICENSE
- it: should not fetch the SMTP password from existing secret because we mount the user-provided secret on the pod directly
  set:
    platform:
      licenseSecretName: unittest
  asserts:
  - notExists:
      path: data.TOWER_LICENSE
- it: should not create any secret when all keys are coming from existing secret because we mount the user-provided secret
    on the pod directly
  set:
    platformDatabase:
      existingSecretName: unittest
    redis:
      existingSecretName: unittest
    platform:
      jwtSeedSecretName: unittest
      cryptoSeedSecretName: unittest
      licenseSecretName: unittest
      smtp:
        host: smtp.example.com
        existingSecretName: unittest
    studios:
      enabled: false
  asserts:
  - equal:
      path: data
      value: null
- it: should create the imagepullsecret if credentials are provided
  documentSelector:
    path: metadata.name
    value: release-name-platform-imagepullsecret
  set:
    global:
      imageCredentials:
      - registry: registry1.example.com/repo1
        username: username1
        password: password1
  asserts:
  - hasDocuments:
      count: 2
  - isKind:
      of: Secret
  - equal:
      path: type
      value: kubernetes.io/dockerconfigjson
  - equal:
      path: data['.dockerconfigjson']
      value: '{"auths":{"registry1.example.com/repo1":{"username":"username1","password":"password1","auth":"dXNlcm5hbWUxOnBhc3N3b3JkMQ=="}}}'
      decodeBase64: true
  - equal:
      path: data
      value:
        .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeTEuZXhhbXBsZS5jb20vcmVwbzEiOnsidXNlcm5hbWUiOiJ1c2VybmFtZTEiLCJwYXNzd29yZCI6InBhc3N3b3JkMSIsImF1dGgiOiJkWE5sY201aGJXVXhPbkJoYzNOM2IzSmtNUT09In19fQ==
- it: should render annotations in all secrets when provided
  set:
    global:
      platformServicePort: 1234
      imageCredentials:
      - registry: registry1.example.com/repo1
        username: username1
        password: password1
    commonAnnotations:
      annotation1: value1
      annotation2: '{{ .Values.global.platformServicePort }}'
  asserts:
  - hasDocuments:
      count: 2
  - equal:
      path: metadata.annotations
      value:
        annotation1: value1
        annotation2: '1234'
- it: should merge annotations from commonAnnotations and platform.secretAnnotations
  set:
    global:
      imageCredentials:
      - registry: registry1.example.com/repo1
        username: username1
        password: password1
    commonAnnotations:
      annotation1: this should get overwritten
      annotation2: this should stay
    platform:
      secretAnnotations:
        annotation1: this overrides the common annotation
  asserts:
  - hasDocuments:
      count: 2
  - equal:
      path: metadata.annotations
      value:
        annotation1: this overrides the common annotation
        annotation2: this should stay
- it: should render labels in all secrets when provided via platform.secretLabels
  set:
    global:
      platformServicePort: 1234
      imageCredentials:
      - registry: registry1.example.com/repo1
        username: username1
        password: password1
    platform:
      secretLabels:
        labelA: valueA
        labelB: '{{ .Values.global.platformServicePort }}'
  asserts:
  - hasDocuments:
      count: 2
  - equal:
      path: metadata.labels
      value:
        labelA: valueA
        labelB: '1234'
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: platform
        app.kubernetes.io/version: 1.2.3-asdf
        helm.sh/chart: platform-9.8.7
- it: should generate OIDC private key when studios is enabled and no key is provided
  set:
    studios:
      enabled: true
    platform:
      oidcPrivateKeyBase64: ''
  asserts:
  - exists:
      path: data['oidc.pem']
  - matchRegex:
      path: data['oidc.pem']
      pattern: '-----BEGIN RSA PRIVATE KEY-----\n[a-zA-Z0-9+/=\n]+\n-----END RSA PRIVATE KEY-----'
      decodeBase64: true
- it: should not include OIDC private key when studios is disabled
  set:
    studios:
      enabled: false
    platform:
      oidcPrivateKeyBase64: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlCb3dJQkFBS0JBUUVBMQ==
  asserts:
  - notExists:
      path: data['oidc.pem']
- it: should not include OIDC private key when using existing secret even if base64 value is provided
  set:
    studios:
      enabled: true
    platform:
      oidcPrivateKeyBase64: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlCb3dJQkFBS0JBUUVBMQ==
      oidcPrivateKeySecretName: my-oidc-secret
  asserts:
  - notExists:
      path: data['oidc.pem']
- it: should include Redis password when not using existing secret
  set:
    redis:
      password: my-redis-password
  asserts:
  - equal:
      path: data.TOWER_REDIS_PASSWORD
      value: my-redis-password
      decodeBase64: true
