# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test Platform ingress
templates:
  - ingress.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
  - it: should not render ingress when disabled
    set:
      ingress:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ingress when enabled
    set:
      ingress:
        enabled: true
    asserts:
      - matchSnapshot: {}

  - it: should set correct hostname
    set:
      ingress:
        enabled: true
      global:
        platformExternalDomain: "platform.example.com"
    asserts:
      - equal:
          path: spec.rules[0].host
          value: platform.example.com

  - it: should apply ingress class
    set:
      ingress:
        enabled: true
        ingressClassName: "nginx"
      global:
        platformExternalDomain: "platform.example.com"
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: should apply ingress annotations with templated values
    set:
      ingress:
        enabled: true
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: "/"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          whatever: "{{ .Values.global.platformServicePort | default 8443 }}"
      global:
        platformExternalDomain: "platform.example.com"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            nginx.ingress.kubernetes.io/rewrite-target: "/"
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
            whatever: "8080"  # should be rendered as string, k8s doesn't accept integers in annotations

  - it: should apply ingress labels with templated values
    set:
      global:
        platformExternalDomain: "platform.example.com"
      ingress:
        enabled: true
        extraLabels:
          domain: "{{ .Values.global.platformExternalDomain }}"
          whatever: "{{ .Values.global.platformServicePort | default 8443 }}"
    asserts:
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: platform
            app.kubernetes.io/version: v9.9.9
            helm.sh/chart: platform-1.2.3
            domain: platform.example.com
            whatever: "8080"  # should be rendered as string, k8s doesn't accept integers in annotations

  - it: should expose user-data. (content) subdomain when enabled
    set:
      global:
        platformExternalDomain: "platform.example.com"
      ingress:
        enabled: true
    asserts:
      - equal:
          path: spec.rules[1]
          value:
            host: "user-data.platform.example.com"
            http:
              paths:
              - backend:
                  service:
                    name: "release-name-platform-frontend"
                    port:
                      number: 80
                path: "/"
                pathType: "ImplementationSpecific"

  - it: should expose user-data. (content) on custom subdomain when enabled
    set:
      global:
        platformExternalDomain: "platform.example.com"
        contentDomain: "user-data.example.com"
      ingress:
        enabled: true
    asserts:
      - equal:
          path: spec.rules[1]
          value:
            host: "user-data.example.com"
            http:
              paths:
              - backend:
                  service:
                    name: "release-name-platform-frontend"
                    port:
                      number: 80
                path: "/"
                pathType: "ImplementationSpecific"

  - it: should not expose user-data. (content) subdomain when not set
    set:
      global:
        platformExternalDomain: "platform.example.com"
        contentDomain: ""
      ingress:
        enabled: true
    asserts:
      - equal:
          path: spec.rules
          value:
            - host: platform.example.com
              http:
                paths:
                  - backend:
                      service:
                        name: release-name-platform-frontend
                        port:
                          number: 80
                    path: /
                    pathType: ImplementationSpecific

  - it: should not expose www subdomain when disabled
    set:
      global:
        platformExternalDomain: "platform.example.com"
      ingress:
        enabled: true
        enableHostOnWWWSubdomain: false
    asserts:
      - equal:
          path: spec.rules
          value:
            - host: platform.example.com
              http:
                paths:
                  - backend:
                      service:
                        name: release-name-platform-frontend
                        port:
                          number: 80
                    path: /
                    pathType: ImplementationSpecific
            - host: user-data.platform.example.com
              http:
                paths:
                  - backend:
                      service:
                        name: release-name-platform-frontend
                        port:
                          number: 80
                    path: /
                    pathType: ImplementationSpecific

  # TODO: set up TLS support
  # - it: should configure TLS when enabled
  #   set:
  #     ingress:
  #       enabled: true
  #       tls:
  #         enabled: true
  #         secretName: "platform-tls"
  #     global:
  #       platformExternalDomain: "platform.example.com"
  #   asserts:
  #     - equal:
  #         path: spec.tls[0].secretName
  #         value: platform-tls
  #     - contains:
  #         path: spec.tls[0].hosts
  #         content: platform.example.com

  # - it: should configure multiple paths
  #   set:
  #     ingress:
  #       enabled: true
  #       paths:
  #         - path: "/"
  #           pathType: "Prefix"
  #           service:
  #             name: "backend"
  #             port: 8080
  #         - path: "/api"
  #           pathType: "Prefix"
  #           service:
  #             name: "api"
  #             port: 8081
  #     global:
  #       platformExternalDomain: "platform.example.com"
  #   asserts:
  #     - equal:
  #         path: spec.rules[0].http.paths[0].path
  #         value: "/*"
  #     - equal:
  #         path: spec.rules[0].http.paths[0].pathType
  #         value: "Prefix"

  - it: should use default path when not set
    set:
      ingress:
        enabled: true
      global:
        platformExternalDomain: "platform.example.com"
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: "/"

  - it: should use custom paths when set
    set:
      ingress:
        enabled: true
        path: "/*"
        contentPath: "/platform/*"
      global:
        platformExternalDomain: "platform.example.com"
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: "/*"
      - equal:
          path: spec.rules[1].http.paths[0].path
          value: "/platform/*"

  - it: should configure extra hosts
    set:
      ingress:
        enabled: true
        extraHosts:
          - host: '{{ printf "api.%s" .Values.global.platformExternalDomain }}'
            paths:
              - path: /*  # For ALB ingress controller
                pathType: Prefix  # Optional, defaults to defaultPathType value
                serviceName: '{{ printf "%s-backend" (include "common.names.fullname" .) }}'
                portNumber: '{{ .Values.global.platformServicePort }}'
          - host: '{{ printf "www.%s" .Values.global.platformExternalDomain }}'
            paths:
              - path: /*  # For ALB ingress controller
                pathType: Prefix  # Optional, defaults to defaultPathType value
                serviceName: '{{ printf "%s-frontend" (include "common.names.fullname" .) }}'
                portNumber: '{{ .Values.frontend.service.http.port }}'
    asserts:
      - matchSnapshot: {}
