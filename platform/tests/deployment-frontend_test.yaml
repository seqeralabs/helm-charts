# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 - 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform frontend deployment
templates:
  - deployment-frontend.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
- it: should produce a Deployment resource with minimal values
  asserts:
  - matchSnapshot: {}
- it: should render the frontend deployment with the specified tag version
  set:
    frontend:
      image:
        tag: 9.0.0
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/frontend:9.0.0
- it: should render the frontend deployment with a tag version ending with -unprivileged depending on the chart appVersion
  chart:
    version: 1.2.3
    appVersion: 9.8.7
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/frontend:9.8.7-unprivileged
- it: should render the frontend deployment with the specified digest, overriding the tag
  set:
    frontend:
      image:
        tag: this will be ignored
        digest: sha256:1234abcdef
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/frontend@sha256:1234abcdef
- it: should render the frontend deployment with the correct labels and annotations
  chart:
    version: 9.9.9+test
    appVersion: 9.9.9
  set:
    platformDatabase:
      existingSecretName: unittest
      existingSecretKey: db-password-key
    commonLabels:
      key123: this-should-be-overridden-in-pod-labels
      key456: this-should-not-be-overridden
      key789: '{{ .Values.global.platformServicePort | default 8443 }}'
    commonAnnotations:
      common-annotation-key: common-annotation-value
    frontend:
      podLabels:
        key123: this-overrides-the-commonLabels
      podAnnotations:
        pod-annotation-key: pod-annotation-value
        pod-annotation-key2: '{{ .Values.global.platformServicePort | default 8443 }}'
  asserts:
  - matchSnapshot: {}
- it: shouldn't obey custom selector requests
  set:
    frontend:
      extraOptionsSpec:
        selector:
          matchLabels:
            app: something-else
  asserts:
  - equal:
      path: spec.selector.matchLabels
      value:
        app.kubernetes.io/component: frontend
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/name: platform
- it: should obey a mix of ignored fields and valid options in extraOptionsSpec
  set:
    frontend:
      extraOptionsSpec:
        replicas: 3
        selector:
          matchLabels:
            app: something-else
        revisionHistoryLimit: 3
  asserts:
  - equal:
      path: spec.replicas
      value: 3
  - equal:
      path: spec.revisionHistoryLimit
      value: 3
  - equal:
      path: spec.selector.matchLabels
      value:
        app.kubernetes.io/component: frontend
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/name: platform
- it: should ignore certain fields that we manage under extraOptionsTemplateSpec
  set:
    frontend:
      extraOptionsTemplateSpec:
        serviceAccountName: some-other-sa
  asserts:
  - equal:
      path: spec.template.spec.serviceAccountName
      value: release-name-platform-sa
- it: should ignore certain managed fields under extraOptionsTemplateSpec and still render others
  set:
    frontend:
      extraOptionsTemplateSpec:
        serviceAccountName: some-other-sa
        dnsPolicy: ClusterFirstWithHostNet
  asserts:
  - equal:
      path: spec.template.spec.serviceAccountName
      value: release-name-platform-sa
  - equal:
      path: spec.template.spec.dnsPolicy
      value: ClusterFirstWithHostNet
- it: should render default podsecurityContext
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 101
- it: should disable podSecurityContext when 'enabled' is false
  set:
    frontend:
      podSecurityContext:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should prevent podSecurityContext to be set via extraOptionsTemplateSpec when 'enabled' is false
  set:
    frontend:
      podSecurityContext:
        enabled: false
      extraOptionsTemplateSpec:
        securityContext:
          fsGroup: 2000
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should render whatever podsecurityContext is set
  set:
    frontend:
      podSecurityContext:
        enabled: true
        fsGroup: 2000
        asdf: 123
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 2000
        asdf: 123
- it: should render custom container securityContext
  set:
    frontend:
      containerSecurityContext:
        capabilities:
          add:
          - NET_ADMIN
        runAsUser: 2000
        runAsNonRoot: false
        readOnlyRootFilesystem: false
        asdf: 123
  asserts:
  - equal:
      path: spec.template.spec.containers[0].securityContext
      value:
        capabilities:
          add:
          - NET_ADMIN
          drop:
          - ALL
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 2000
        asdf: 123
- it: should render container with extraEnvVars, extraEnvVarsCMs and extraEnvVarsSecrets
  set:
    frontend:
      extraEnvVars:
      - name: CUSTOM_ENV_VAR
        value: custom-value
      extraEnvVarsCMs:
      - extra-env-vars-cm1
      - extra-env-vars-cm2
      extraEnvVarsSecrets:
      - extra-env-vars-secret1
      - extra-env-vars-secret2
  asserts:
  - equal:
      path: spec.template.spec.containers[0].env
      value:
      - name: NGINX_UPSTREAM_HOST
        value: release-name-platform-backend
      - name: NGINX_UPSTREAM_PORT
        value: '8080'
      - name: NGINX_LISTEN_PORT
        value: '8083'
      - name: CUSTOM_ENV_VAR
        value: custom-value
  - equal:
      path: spec.template.spec.containers[0].envFrom
      value:
      - configMapRef:
          name: extra-env-vars-cm1
      - configMapRef:
          name: extra-env-vars-cm2
      - secretRef:
          name: extra-env-vars-secret1
      - secretRef:
          name: extra-env-vars-secret2
- it: should render extra initContainer
  set:
    frontend:
      initContainers:
      - name: extra-init-container
        image: busybox:latest
        command:
        - sh
        - -c
        - echo Hello from extra init container
  asserts:
  - lengthEqual:
      path: spec.template.spec.initContainers
      count: 1
  - equal:
      path: spec.template.spec.initContainers[0]
      value:
        name: extra-init-container
        image: busybox:latest
        command:
        - sh
        - -c
        - echo Hello from extra init container
- it: should render multiple extra initContainers
  set:
    frontend:
      initContainers:
      - name: extra-init-container1
        image: busybox:latest
        command:
        - sh
        - -c
        - echo Hello from extra init container
      - name: extra-init-container2
        image: alpine:latest
        command:
        - sh
        - -c
        - echo Hello from another extra init container
  asserts:
  - lengthEqual:
      path: spec.template.spec.initContainers
      count: 2
  - equal:
      path: spec.template.spec.initContainers[0]
      value:
        name: extra-init-container1
        image: busybox:latest
        command:
        - sh
        - -c
        - echo Hello from extra init container
  - equal:
      path: spec.template.spec.initContainers[1]
      value:
        name: extra-init-container2
        image: alpine:latest
        command:
        - sh
        - -c
        - echo Hello from another extra init container
- it: should include extra volumeMounts in the frontend container
  set:
    frontend:
      extraVolumeMounts:
      - name: extra-volume
        mountPath: /extra/path
  asserts:
  - equal:
      path: spec.template.spec.containers[0].volumeMounts
      value:
      - mountPath: /extra/path
        name: extra-volume
      - mountPath: /tmp/
        name: tmp-volume
      - mountPath: /etc/nginx/conf.d/
        name: nginx-conf-volume
- it: should disable probes for the frontend container
  set:
    frontend:
      livenessProbe:
        enabled: false
      readinessProbe:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.containers[0].livenessProbe
  - notExists:
      path: spec.template.spec.containers[0].readinessProbe
  - notExists:
      path: spec.template.spec.containers[0].startupProbe
