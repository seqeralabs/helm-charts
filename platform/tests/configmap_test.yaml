# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 - 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform configmaps
templates:
  - configmap.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
tests:
- it: should render 4 different CM documents by default
  asserts:
  - hasDocuments:
      count: 4
- it: should render cron cm with default values
  documentSelector:
    path: metadata.name
    value: release-name-platform-cron
  asserts:
  - isKind:
      of: ConfigMap
  - equal:
      path: data
      value:
        MICRONAUT_ENVIRONMENTS: prod,redis,cron
        TOWER_CRON_SERVER_PORT: '8082'
- it: should setup requested micronaut envs for cron when required, in addition to the mandatory ones
  documentSelector:
    path: metadata.name
    value: release-name-platform-cron
  set:
    cron:
      micronautEnvironments:
      - prod
      - whatever1
      - whatever2
  asserts:
  - isKind:
      of: ConfigMap
  - equal:
      path: data.MICRONAUT_ENVIRONMENTS
      value: prod,whatever1,whatever2,redis,cron
- it: should not include TOWER_DATA_STUDIO_CONNECT_URL when studios is disabled
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    studios:
      enabled: false
  asserts:
  - notExists:
      path: data.TOWER_DATA_STUDIO_CONNECT_URL
- it: should apply common labels
  chart:
    version: 9.8.7
    appVersion: v1.2.3+abcdef
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    commonLabels:
      environment: dev
      team: platform
      numericLabelAsString: '{{ .Values.global.platformServicePort | default 1234 }}'
  asserts:
  - equal:
      path: metadata.labels
      value:
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: platform
        app.kubernetes.io/version: v1.2.3+abcdef
        helm.sh/chart: platform-9.8.7
        environment: dev
        team: platform
        numericLabelAsString: '8080'
- it: should render env var with the requested execution backends
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platform:
      executionBackends:
      - altair-platform
      - slurm-platform
  asserts:
  - equal:
      path: data.TOWER_ENABLE_PLATFORMS
      value: altair-platform,slurm-platform
- it: should render tower-yml cm with provided data
  documentSelector:
    path: metadata.name
    value: release-name-platform-tower-yml
  set:
    platform:
      YAMLConfigFileContent: "someKey: someValue\nanotherKey:\n  nestedKey: nestedValue\n"
  asserts:
  - equal:
      path: data
      value:
        tower.yml: "tower:\n  data-studio:\n    allowed-workspaces: null\n---\nsomeKey: someValue\nanotherKey:\n  nestedKey:\
          \ nestedValue"
- it: should render annotations in all configmaps when provided
  set:
    global:
      platformServicePort: 1234
    commonAnnotations:
      annotation1: value1
      annotation2: '{{ .Values.global.platformServicePort }}'
  asserts:
  - hasDocuments:
      count: 4
  - equal:
      path: metadata.annotations
      value:
        annotation1: value1
        annotation2: '1234'
- it: should merge annotations from commonAnnotations and platform.configMapAnnotations
  set:
    commonAnnotations:
      annotation1: this should get overwritten
      annotation2: this should stay
    platform:
      configMapAnnotations:
        annotation1: this overrides the common annotation
  asserts:
  - hasDocuments:
      count: 4
  - equal:
      path: metadata.annotations
      value:
        annotation1: this overrides the common annotation
        annotation2: this should stay
- it: should render labels in all configmaps when provided via platform.configMapLabels
  chart:
    version: 9.8.7
    appVersion: v1.2.3+abcdef
  set:
    global:
      platformServicePort: 1234
    platform:
      configMapLabels:
        labelA: valueA
        labelB: '{{ .Values.global.platformServicePort }}'
  asserts:
  - hasDocuments:
      count: 4
  - equal:
      path: metadata.labels
      value:
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: platform
        app.kubernetes.io/version: v1.2.3+abcdef
        helm.sh/chart: platform-9.8.7
        labelA: valueA
        labelB: '1234'
- it: should render database driver correctly with default "mariadb"
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  asserts:
  - equal:
      path: data.TOWER_DB_DRIVER
      value: org.mariadb.jdbc.Driver
- it: should render database driver correctly when using "mysql" as alias
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platformDatabase:
      driver: mysql
  asserts:
  - equal:
      path: data.TOWER_DB_DRIVER
      value: org.mariadb.jdbc.Driver
- it: should fail when empty database driver is provided
  set:
    platformDatabase:
      driver: ''
  asserts:
  - failedTemplate:
      errorMessage: 'Unsupported database driver: ''''. Supported drivers are: ''mariadb'' (or its alias ''mysql'').'
- it: should render db dialect correctly when explicitly set to "mysql-8"
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platformDatabase:
      dialect: mysql-8
  asserts:
  - equal:
      path: data.TOWER_DB_DIALECT
      value: io.seqera.util.MySQL8DialectCollateBin
- it: should fail when database dialect is unsupported
  set:
    platformDatabase:
      dialect: unsupported-dialect
  asserts:
  - failedTemplate:
      errorMessage: 'Unsupported database dialect: ''unsupported-dialect''. Supported dialects are: ''mysql-8'', ''mariadb-10''.'
- it: should render database url correctly for mariadb driver with default list of parameters
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  asserts:
  - equal:
      path: data.TOWER_DB_URL
      value: jdbc:mysql://:3306/?permitMysqlScheme=true
- it: should render database url correctly for mysql driver (alias for mariadb) with specified parameters
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platformDatabase:
      connectionOptions:
        mariadb: []
        mysql:
        - param1=value1
        - param2=value2
  asserts:
  - equal:
      path: data.TOWER_DB_URL
      value: jdbc:mysql://:3306/?param1=value1&param2=value2
- it: should render database url correctly using mariadb options when no mysql options are provided
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platformDatabase:
      connectionOptions:
        mariadb:
        - param1=value1
        - param2=value2
        mysql: []
  asserts:
  - equal:
      path: data.TOWER_DB_URL
      value: jdbc:mysql://:3306/?param1=value1&param2=value2
- it: should render database url with custom database name
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platformDatabase:
      host: db.example.com
      port: 3306
      name: tower_db
  asserts:
  - equal:
      path: data.TOWER_DB_URL
      value: jdbc:mysql://db.example.com:3306/tower_db?permitMysqlScheme=true
- it: should render database url with custom name and connection options
  documentSelector:
    path: metadata.name
    value: release-name-platform-shared-backend-cron
  set:
    platformDatabase:
      host: prod-db.example.com
      port: 3306
      name: production_db
      connectionOptions:
        mariadb:
        - useSSL=true
        - serverTimezone=UTC
  asserts:
  - equal:
      path: data.TOWER_DB_URL
      value: jdbc:mysql://prod-db.example.com:3306/production_db?useSSL=true&serverTimezone=UTC
- it: should render Studios tools environment variables when studios is enabled with default tools
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  asserts:
  - matchSnapshot: {}
- it: should render custom Studios tool when provided
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    platform:
      studios:
        tools:
          customtool:
            tool: customtool
            recommended: registry.example.com/custom-tool:v1.0.0
  asserts:
  - matchSnapshot: {}
- it: should render custom Studios tool with deprecated and experimental versions when provided
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    platform:
      studios:
        tools:
          customtool:
            tool: customtool
            recommended: registry.example.com/custom-tool:v2.0.0
            deprecated: registry.example.com/custom-tool:v1.0.0
            experimental: registry.example.com/custom-tool:v3.0.0
  asserts:
  - matchSnapshot: {}
- it: should turn on data explorer flag when enabled
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    platform:
      dataExplorer:
        enabled: true
  asserts:
  - equal:
      path: data.TOWER_DATA_EXPLORER_ENABLED
      value: 'true'
- it: should turn on data explorer flag when studios is enabled even if dataExplorer is disabled
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    platform:
      dataExplorer:
        enabled: false
    studios:
      enabled: true
  asserts:
  - equal:
      path: data.TOWER_DATA_EXPLORER_ENABLED
      value: 'true'
- it: should render Studios Wave custom image registry and repository when configured
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    studios:
      enabled: true
    platform:
      studios:
        customImageRegistry: myregistry.example.com
        customImageRepository: myteam/studios-repo
  asserts:
  - equal:
      path: data.TOWER_DATA_STUDIO_WAVE_CUSTOM_IMAGE_REGISTRY
      value: myregistry.example.com
  - equal:
      path: data.TOWER_DATA_STUDIO_WAVE_CUSTOM_IMAGE_REPOSITORY
      value: myteam/studios-repo
- it: should fail when database driver is unsupported
  set:
    platformDatabase:
      driver: unsupported
  asserts:
  - failedTemplate:
      errorMessage: 'Unsupported database driver: ''unsupported''. Supported drivers are: ''mariadb'' (or its alias ''mysql'').'
- it: should not render Studios tools environment variables when studios is disabled
  documentSelector:
    path: metadata.name
    value: release-name-platform-backend
  set:
    studios:
      enabled: false
  asserts:
  - equal:
      path: data
      value:
        GROUNDSWELL_SERVER_URL: http://RELEASE-NAME-pipeline-optimization:8090
        MICRONAUT_ENVIRONMENTS: prod,redis,ha,wave,groundswell
        TOWER_DATA_EXPLORER_ENABLED: 'false'
