# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test Platform service
templates:
  - service.yaml
tests:
  - it: should render 3 services by default
    asserts:
      - hasDocuments:
          count: 3

  - it: should render backend service correctly by default
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should render cron service correctly by default
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082

  - it: should render frontend service correctly by default
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083

  - it: should render backend service with custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      backend:
        service:
          type: NodePort
          http:
            nodePort: 30080
    asserts:
      - equal:
          path: spec
          value:
            type: NodePort
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
                nodePort: 30080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should render cron service with custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    set:
      cron:
        service:
          type: NodePort
          http:
            nodePort: 30081
    asserts:
      - equal:
          path: spec
          value:
            type: NodePort
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082
                nodePort: 30081

  - it: should render frontend service with custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    set:
      frontend:
        service:
          type: NodePort
          http:
            nodePort: 30082
    asserts:
      - equal:
          path: spec
          value:
            type: NodePort
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083
                nodePort: 30082

  - it: should render backend service with LoadBalancer type and custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      backend:
        service:
          type: LoadBalancer
          http:
            nodePort: 30080
    asserts:
      - equal:
          path: spec
          value:
            type: LoadBalancer
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
                nodePort: 30080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should render cron service with LoadBalancer type and custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    set:
      cron:
        service:
          type: LoadBalancer
          http:
            nodePort: 30081
    asserts:
      - equal:
          path: spec
          value:
            type: LoadBalancer
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082
                nodePort: 30081

  - it: should render frontend service with LoadBalancer type and custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    set:
      frontend:
        service:
          type: LoadBalancer
          http:
            nodePort: 30082
    asserts:
      - equal:
          path: spec
          value:
            type: LoadBalancer
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083
                nodePort: 30082

  - it: should render backend service with ExternalName type and external address, ignoring nodePort
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      backend:
        service:
          type: ExternalName
          extraOptions:
            externalName: my-external-service.example.com
          http:
            nodePort: 30080
    asserts:
      - equal:
          path: spec
          value:
            type: ExternalName
            externalName: my-external-service.example.com
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should render cron service with ExternalName type and external address, ignoring nodePort
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    set:
      cron:
        service:
          type: ExternalName
          extraOptions:
            externalName: my-external-service.example.com
          http:
            nodePort: 30081
    asserts:
      - equal:
          path: spec
          value:
            type: ExternalName
            externalName: my-external-service.example.com
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082

  - it: should render frontend service with ExternalName type and external address, ignoring nodePort
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    set:
      frontend:
        service:
          type: ExternalName
          extraOptions:
            externalName: my-external-service.example.com
          http:
            nodePort: 30082
    asserts:
      - equal:
          path: spec
          value:
            type: ExternalName
            externalName: my-external-service.example.com
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083

  - it: should not render backend service with custom nodePort when not using NodePort or LoadBalancer
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      backend:
        service:
          type: ClusterIP
          http:
            nodePort: 30080
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should not render cron service with custom nodePort when not using NodePort or LoadBalancer
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    set:
      cron:
        service:
          type: ClusterIP
          http:
            nodePort: 30081
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082

  - it: should not render frontend service with custom nodePort when not using NodePort or LoadBalancer
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    set:
      frontend:
        service:
          type: ClusterIP
          http:
            nodePort: 30082
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083

  - it: should render backend service correctly with custom ports and custom service name
    chart:
      version: 9.9.9
      appVersion: "1.2.3+asdf"
    documentSelector:
      path: metadata.name
      value: custom-backend-service-name
    set:
      global:
        platformServiceAddress: custom-backend-service-name
        platformServicePort: 9123
      backend:
        service:
          http:
            port: 9090
            targetPort: 9090
          name: custom-http-name
    asserts:
      - equal:
          path: metadata
          value:
            name: custom-backend-service-name
            namespace: NAMESPACE
            labels:
              app.kubernetes.io/instance: RELEASE-NAME
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: platform
              app.kubernetes.io/version: 1.2.3+asdf
              helm.sh/chart: platform-9.9.9
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 9123
                targetPort: 8080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should apply commonLabels to backend service
    set:
      commonLabels:
        commonKey: commonValue
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: metadata.labels.commonKey
          value: commonValue
        documentIndex: 0

  - it: should apply tower.serviceLabels to backend service
    set:
      tower:
        serviceLabels:
          towerKey: towerValue
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: metadata.labels.towerKey
          value: towerValue
        documentIndex: 0

  - it: should merge commonLabels and tower.serviceLabels for backend service
    set:
      commonLabels:
        commonKey: commonValue
        anotherCommonKey: anotherCommonValue
      tower:
        serviceLabels:
          towerKey: towerValue
          commonKey: towerOverrideValue # tower.serviceLabels should override commonLabels
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: metadata.labels.commonKey
          value: towerOverrideValue
        documentIndex: 0
      - equal:
          path: metadata.labels.anotherCommonKey
          value: anotherCommonValue
        documentIndex: 0
      - equal:
          path: metadata.labels.towerKey
          value: towerValue
        documentIndex: 0

  - it: should apply commonAnnotations to backend service
    set:
      commonAnnotations:
        commonAnnotationKey: commonAnnotationValue
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: metadata.annotations.commonAnnotationKey
          value: commonAnnotationValue
        documentIndex: 0

  - it: should apply tower.serviceAnnotations to backend service
    set:
      tower:
        serviceAnnotations:
          towerAnnotationKey: towerAnnotationValue
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: metadata.annotations.towerAnnotationKey
          value: towerAnnotationValue
        documentIndex: 0

  - it: should merge commonAnnotations and tower.serviceAnnotations for backend service
    set:
      commonAnnotations:
        commonAnnotationKey: commonAnnotationValue
        anotherCommonAnnotationKey: anotherCommonAnnotationValue
      tower:
        serviceAnnotations:
          towerAnnotationKey: towerAnnotationValue
          commonAnnotationKey: towerAnnotationOverrideValue # tower.serviceAnnotations should override commonAnnotations
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: metadata.annotations.commonAnnotationKey
          value: towerAnnotationOverrideValue
        documentIndex: 0
      - equal:
          path: metadata.annotations.anotherCommonAnnotationKey
          value: anotherCommonAnnotationValue
        documentIndex: 0
      - equal:
          path: metadata.annotations.towerAnnotationKey
          value: towerAnnotationValue
        documentIndex: 0

  - it: should render backend service with extraOptions
    set:
      backend:
        service:
          type: ClusterIP
          extraOptions:
            sessionAffinity: ClientIP
            loadBalancerIP: 1.2.3.4
    asserts:
      - equal:
          path: spec.sessionAffinity
          value: ClientIP
        documentIndex: 0
      - equal:
          path: spec.loadBalancerIP
          value: 1.2.3.4
        documentIndex: 0

  - it: should not render extraOptions if not defined for backend service
    set:
      backend:
        service:
          type: ClusterIP
    asserts:
      - notExists:
          path: spec.sessionAffinity
        documentIndex: 0
      - notExists:
          path: spec.loadBalancerIP
        documentIndex: 0

  - it: should omit selector, type, and ports from extraOptions for backend service
    set:
      backend:
        service:
          type: ClusterIP
          extraOptions:
            selector:
              app: test
            type: NodePort
            ports:
              - port: 80
            customOption: customValue
    asserts:
      - equal:
          path: spec.selector
          value:
            app.kubernetes.io/name: platform
            app.kubernetes.io/instance: RELEASE-NAME
            app: backend
        documentIndex: 0
      - equal:
          path: spec.type
          value: ClusterIP
        documentIndex: 0
      - equal:
          path: spec.ports
          value:
            - name: http
              port: 8080
              targetPort: 8080
            - name: jmx
              port: 1099
              targetPort: 1099
        documentIndex: 0
      - equal:
          path: spec.customOption
          value: customValue
        documentIndex: 0

  - it: should not apply custom backend.podLabels to backend service selector, only if they override standard labels
    set:
      backend:
        podLabels:
          podLabelKey: podLabelValue
          app.kubernetes.io/name: custom
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: spec.selector
          value:
            app: backend
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: custom
        documentIndex: 0

  - it: should verify http.name defaults to http for backend service
    set:
      backend:
        service:
          type: ClusterIP
          http:
            port: 80
    asserts:
      - equal:
          path: spec.ports[0].name
          value: http
        documentIndex: 0

  - it: should verify http.name is set correctly for backend service
    set:
      backend:
        service:
          type: ClusterIP
          http:
            name: custom-http
            port: 80
    asserts:
      - equal:
          path: spec.ports[0].name
          value: custom-http
        documentIndex: 0

  - it: should verify port uses global.platformServicePort for backend service
    set:
      global:
        platformServicePort: 8081
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 8081
        documentIndex: 0

  - it: should verify targetPort is hardcoded to 8080 for backend service
    set:
      backend:
        service:
          type: ClusterIP
    asserts:
      - equal:
          path: spec.ports[0].targetPort
          value: 8080
        documentIndex: 0
