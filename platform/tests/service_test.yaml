# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test Platform service
templates:
  - service.yaml
tests:
  - it: should render 3 services by default
    asserts:
      - hasDocuments:
          count: 3

  - it: should render backend service correctly by default
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should render cron service correctly by default
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082

  - it: should render frontend service correctly by default
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    asserts:
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083

  - it: should render backend service with custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-backend
    set:
      backend:
        service:
          type: NodePort
          http:
            nodePort: 30080
    asserts:
      - equal:
          path: spec
          value:
            type: NodePort
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 8080
                targetPort: 8080
                nodePort: 30080
              - name: jmx
                port: 1099
                targetPort: 1099

  - it: should render cron service with custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-cron
    set:
      cron:
        service:
          type: NodePort
          http:
            nodePort: 30081
    asserts:
      - equal:
          path: spec
          value:
            type: NodePort
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: cron
            ports:
              - name: http
                port: 8080
                targetPort: 8082
                nodePort: 30081

  - it: should render frontend service with custom type when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    set:
      frontend:
        service:
          type: LoadBalancer
    asserts:
      - equal:
          path: spec
          value:
            type: LoadBalancer
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083

  - it: should render frontend service with custom nodePort when requested
    documentSelector:
      path: metadata.name
      value: release-name-platform-frontend
    set:
      frontend:
        service:
          type: NodePort
          http:
            nodePort: 30082
    asserts:
      - equal:
          path: spec
          value:
            type: NodePort
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: frontend
            ports:
              - name: http
                port: 80
                targetPort: 8083
                nodePort: 30082

  - it: should render backend service correctly with custom ports and custom service name
    chart:
      version: 9.9.9
      appVersion: "1.2.3+asdf"
    documentSelector:
      path: metadata.name
      value: custom-backend-service-name
    set:
      global:
        platformServiceAddress: custom-backend-service-name
        platformServicePort: 9123
      backend:
        service:
          http:
            port: 9090
            targetPort: 9090
          name: custom-http-name
    asserts:
      - equal:
          path: metadata
          value:
            name: custom-backend-service-name
            namespace: NAMESPACE
            labels:
              app.kubernetes.io/instance: RELEASE-NAME
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: platform
              app.kubernetes.io/version: 1.2.3+asdf
              helm.sh/chart: platform-9.9.9
      - equal:
          path: spec
          value:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: platform
              app.kubernetes.io/instance: RELEASE-NAME
              app: backend
            ports:
              - name: http
                port: 9123
                targetPort: 8080
              - name: jmx
                port: 1099
                targetPort: 1099
