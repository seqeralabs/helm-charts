# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
#
# Copyright (c) 2025 - 2026 Seqera Labs
# All rights reserved.
#
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

suite: test Platform cron deployment
templates:
  - deployment-cron.yaml
  - secret.yaml
  - configmap.yaml
chart:
  version: 1.2.3
  appVersion: "v9.9.9"
# To avoid expensive RSA key generation in tests, we set a default oidcPrivateKeyBase64 value.
# Tests can override this if they need to test key generation specifically.
set:
  platform:
    oidcPrivateKeyBase64: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlCb3dJQkFBS0JBUUVBMQ=="
tests:
- it: should produce a Deployment resource with minimal values
  template: deployment-cron.yaml
  asserts:
  - matchSnapshot:
      path: spec.template.spec
- it: should render the cron deployment with the specified tag version
  template: deployment-cron.yaml
  set:
    cron:
      image:
        tag: 9.0.0
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/backend:9.0.0
- it: should render the cron deployment with the specified digest, overriding the tag
  template: deployment-cron.yaml
  set:
    cron:
      image:
        tag: this will be ignored
        digest: sha256:1234abcdef
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/backend@sha256:1234abcdef
- it: should render the cron deployment with the correct checksums, labels and annotations
  template: deployment-cron.yaml
  chart:
    version: 9.9.9+test
    appVersion: 9.9.9
  kubernetesProvider:
    scheme:
      v1/Secret:
        gvr:
          version: v1
          resource: secrets
        namespaced: true
    objects:
    - apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: unittest
        namespace: NAMESPACE
      data:
        db-password-key: bXktZGItcGFzc3dvcmQxMjM=
        license-token-key: bXktcGxhdGZvcm0tbGljZW5zZTEyMw==
  set:
    platformDatabase:
      existingSecretName: unittest
      existingSecretKey: db-password-key
    commonLabels:
      key123: this-should-be-overridden-in-pod-labels
      key456: this-should-not-be-overridden
      key789: '{{ .Values.global.platformServicePort | default 8443 }}'
    commonAnnotations:
      common-annotation-key: common-annotation-value
    cron:
      podLabels:
        key123: this-overrides-the-commonLabels
      podAnnotations:
        pod-annotation-key: pod-annotation-value
        pod-annotation-key2: '{{ .Values.global.platformServicePort | default 8443 }}'
    platform:
      jwtSeedString: these need to be defined
      cryptoSeedString: otherwise 'helm template' creates random ones each time
      licenseSecretName: unittest
      licenseSecretKey: license-token-key
  asserts:
  - matchSnapshot: {}
- it: shouldn't obey custom selector requests
  template: deployment-cron.yaml
  set:
    cron:
      extraOptionsSpec:
        selector:
          matchLabels:
            app: something-else
  asserts:
  - equal:
      path: spec.selector.matchLabels
      value:
        app.kubernetes.io/component: cron
        app.kubernetes.io/instance: RELEASE-NAME
        app.kubernetes.io/name: platform
- it: shouldn't obey custom replicas requests
  template: deployment-cron.yaml
  set:
    cron:
      extraOptionsSpec:
        replicas: 3
  asserts:
  - equal:
      path: spec.replicas
      value: 1
- it: shouldn't obey custom strategy requests
  template: deployment-cron.yaml
  set:
    cron:
      extraOptionsSpec:
        strategy:
          type: RollingUpdate
          rollingUpdate:
            maxUnavailable: 1
            maxSurge: 1
  asserts:
  - equal:
      path: spec.strategy.type
      value: Recreate
- it: should render extraOptionsTemplateSpec under spec.template.spec (simple test)
  template: deployment-cron.yaml
  set:
    cron:
      extraOptionsTemplateSpec:
        nodeSelector:
          disktype: ssd
  asserts:
  - equal:
      path: spec.template.spec.nodeSelector
      value:
        disktype: ssd
- it: should render extraOptionsTemplateSpec under spec.template.spec
  template: deployment-cron.yaml
  set:
    cron:
      extraOptionsTemplateSpec:
        nodeSelector:
          disktype: ssd
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - whatever
              topologyKey: kubernetes.io/hostname
  asserts:
  - equal:
      path: spec.template.spec.nodeSelector
      value:
        disktype: ssd
  - equal:
      path: spec.template.spec.affinity
      value:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - whatever
            topologyKey: kubernetes.io/hostname
- it: should ignore certain managed fields under extraOptionsTemplateSpec and still render others
  template: deployment-cron.yaml
  set:
    cron:
      extraOptionsTemplateSpec:
        serviceAccountName: some-other-sa
        dnsPolicy: ClusterFirstWithHostNet
  asserts:
  - equal:
      path: spec.template.spec.serviceAccountName
      value: release-name-platform-sa
  - equal:
      path: spec.template.spec.dnsPolicy
      value: ClusterFirstWithHostNet
- it: should disable podSecurityContext when 'enabled' is false
  template: deployment-cron.yaml
  set:
    cron:
      podSecurityContext:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should prevent podSecurityContext to be set via extraOptionsTemplateSpec when 'enabled' is false
  template: deployment-cron.yaml
  set:
    cron:
      podSecurityContext:
        enabled: false
      extraOptionsTemplateSpec:
        securityContext:
          fsGroup: 2000
  asserts:
  - notExists:
      path: spec.template.spec.securityContext
- it: should omit the 'enabled' field from podSecurityContext
  template: deployment-cron.yaml
  set:
    cron:
      podSecurityContext:
        enabled: true
  asserts:
  - notExists:
      path: spec.template.spec.securityContext.enabled
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 101
- it: should render whatever podsecurityContext is set
  template: deployment-cron.yaml
  set:
    cron:
      podSecurityContext:
        enabled: true
        fsGroup: 2000
        asdf: 123
  asserts:
  - equal:
      path: spec.template.spec.securityContext
      value:
        fsGroup: 2000
        asdf: 123
- it: should render custom container securityContext
  template: deployment-cron.yaml
  set:
    cron:
      containerSecurityContext:
        capabilities:
          add:
          - NET_ADMIN
        runAsUser: 2000
        runAsNonRoot: false
        readOnlyRootFilesystem: false
        asdf: 123
  asserts:
  - equal:
      path: spec.template.spec.containers[0].securityContext
      value:
        capabilities:
          add:
          - NET_ADMIN
          drop:
          - ALL
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 2000
        asdf: 123
- it: should render initContainers that wait for required services to be ready and to migrate the DB
  template: deployment-cron.yaml
  asserts:
  - lengthEqual:
      path: spec.template.spec.initContainers
      count: 3
  - equal:
      path: spec.template.spec.initContainers[0].name
      value: wait-for-platform-db
  - equal:
      path: spec.template.spec.initContainers[1].name
      value: wait-for-redis
  - equal:
      path: spec.template.spec.initContainers[2].name
      value: migrate-db
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: private/nf-tower-enterprise/migrate-db:v9.9.9
  - equal:
      path: spec.template.spec.initContainers[0].env
      value:
      - name: SLEEP_PERIOD_SECONDS
        value: '5'
      - name: DB_HOST
        value: ''
      - name: DB_PORT
        value: '3306'
      - name: DB_NAME
        value: ''
      - name: DB_USERNAME
        value: ''
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_DB_PASSWORD
  - equal:
      path: spec.template.spec.initContainers[1].env
      value:
      - name: SLEEP_PERIOD_SECONDS
        value: '5'
      - name: REDIS_URI
        value: redis://:6379
  - equal:
      path: spec.template.spec.initContainers[2].env
      value:
      - name: TOWER_DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_DB_PASSWORD
- it: should render initContainer with appropriate env vars
  template: deployment-cron.yaml
  kubernetesProvider:
    scheme:
      v1/Secret:
        gvr:
          version: v1
          resource: secrets
        namespaced: true
    objects:
    - apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: my-db-secret
        namespace: NAMESPACE
      data:
        my-db-password-key: bXktZGItcGFzc3dvcmQxMjM=
  set:
    platformDatabase:
      host: my-db-host
      port: 3307
      name: my-db-name
      username: my-db-username
      existingSecretName: my-db-secret
      existingSecretKey: my-db-password-key
    redis:
      host: my-redis-host
      port: 6380
      password: my-redis-password123
    cron:
      dbMigrationInitContainer:
        extraEnvVars:
        - name: CUSTOM_ENV_VAR
          value: custom-value
        - name: STRING_VAR
          value: some-string-value
        - name: INTEGER_VAR
          value: 12345
        - name: QUOTED_INTEGER_VAR
          value: "67890"
        - name: MY_SECRET_VAR
          valueFrom:
            secretKeyRef:
              name: my-secret
              key: my-key
        - name: TEMPLATED_VAR
          value: '{{ .Values.global.platformServicePort }}'
        extraEnvVarsCMs:
        - extra-env-vars-cm1
        - extra-env-vars-cm2
        extraEnvVarsSecrets:
        - extra-env-vars-secret1
        - extra-env-vars-secret2
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].env
      value:
      - name: SLEEP_PERIOD_SECONDS
        value: '5'
      - name: DB_HOST
        value: my-db-host
      - name: DB_PORT
        value: '3307'
      - name: DB_NAME
        value: my-db-name
      - name: DB_USERNAME
        value: my-db-username
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: my-db-secret
            key: my-db-password-key
  - equal:
      path: spec.template.spec.initContainers[1].env
      value:
      - name: SLEEP_PERIOD_SECONDS
        value: '5'
      - name: REDIS_URI
        value: redis://my-redis-host:6380
      - name: REDISCLI_AUTH
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_REDIS_PASSWORD
  - equal:
      path: spec.template.spec.initContainers[2].env
      value:
      - name: TOWER_DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: my-db-secret
            key: my-db-password-key
      - name: CUSTOM_ENV_VAR
        value: "custom-value"
      - name: STRING_VAR
        value: some-string-value
      - name: INTEGER_VAR
        value: "12345"
      - name: QUOTED_INTEGER_VAR
        value: "67890"
      - name: MY_SECRET_VAR
        valueFrom:
          secretKeyRef:
            name: my-secret
            key: my-key
      - name: TEMPLATED_VAR
        value: "8080"
  - equal:
      path: spec.template.spec.initContainers[2].envFrom
      value:
      - configMapRef:
          name: release-name-platform-cron
      - configMapRef:
          name: release-name-platform-shared-backend-cron
      - secretRef:
          name: release-name-platform-backend
      - configMapRef:
          name: extra-env-vars-cm1
      - configMapRef:
          name: extra-env-vars-cm2
      - secretRef:
          name: extra-env-vars-secret1
      - secretRef:
          name: extra-env-vars-secret2
- it: should render multiple extra initContainers
  template: deployment-cron.yaml
  set:
    cron:
      initContainers:
      - name: extra-init-container1
        image: busybox:latest
        command:
        - sh
        - -c
        - echo Hello from extra init container
      - name: extra-init-container2
        image: alpine:latest
        command:
        - sh
        - -c
        - echo Hello from another extra init container
  asserts:
  - lengthEqual:
      path: spec.template.spec.initContainers
      count: 5
  - equal:
      path: spec.template.spec.initContainers[3]
      value:
        name: extra-init-container1
        image: busybox:latest
        command:
        - sh
        - -c
        - echo Hello from extra init container
  - equal:
      path: spec.template.spec.initContainers[4]
      value:
        name: extra-init-container2
        image: alpine:latest
        command:
        - sh
        - -c
        - echo Hello from another extra init container

- it: should render cron container with extraEnvVars, extraEnvVarsCMs and extraEnvVarsSecrets
  template: deployment-cron.yaml
  set:
    cron:
      extraEnvVars:
      - name: CUSTOM_ENV_VAR
        value: custom-value
      - name: STRING_VAR
        value: some-string-value
      - name: INTEGER_VAR
        value: 12345
      - name: QUOTED_INTEGER_VAR
        value: "67890"
      - name: MY_SECRET_VAR
        valueFrom:
          secretKeyRef:
            name: my-secret
            key: my-key
      - name: TEMPLATED_VAR
        value: '{{ .Values.global.platformServicePort }}'
      extraEnvVarsCMs:
      - extra-env-vars-cm1
      - extra-env-vars-cm2
      extraEnvVarsSecrets:
      - extra-env-vars-secret1
      - extra-env-vars-secret2
  asserts:
  - equal:
      path: spec.template.spec.containers[0].env
      value:
      - name: TOWER_DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_DB_PASSWORD
      - name: TOWER_LICENSE
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_LICENSE
      - name: TOWER_JWT_SECRET
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_JWT_SECRET
      - name: TOWER_CRYPTO_SECRETKEY
        valueFrom:
          secretKeyRef:
            name: release-name-platform-backend
            key: TOWER_CRYPTO_SECRETKEY
      - name: NXF_HOME
        value: /var/cache/tower/
      - name: NXF_PLUGINS_DIR
        value: /var/cache/tower/plugins/
      - name: CUSTOM_ENV_VAR
        value: "custom-value"
      - name: STRING_VAR
        value: some-string-value
      - name: INTEGER_VAR
        value: "12345"
      - name: QUOTED_INTEGER_VAR
        value: "67890"
      - name: MY_SECRET_VAR
        valueFrom:
          secretKeyRef:
            name: my-secret
            key: my-key
      - name: TEMPLATED_VAR
        value: "8080"
  - equal:
      path: spec.template.spec.containers[0].envFrom
      value:
      - configMapRef:
          name: release-name-platform-cron
      - configMapRef:
          name: release-name-platform-shared-backend-cron
      - configMapRef:
          name: extra-env-vars-cm1
      - configMapRef:
          name: extra-env-vars-cm2
      - secretRef:
          name: extra-env-vars-secret1
      - secretRef:
          name: extra-env-vars-secret2

- it: should prevent initContainer securityContext to be set via extraEnvVars when 'enabled' is false
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        containerSecurityContext:
          enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.initContainers[2].securityContext
- it: should render custom initContainer securityContext
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        enabled: true
        containerSecurityContext:
          capabilities:
            add:
            - NET_ADMIN
          runAsUser: 2000
          runAsNonRoot: false
          readOnlyRootFilesystem: false
          asdf: 123
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].securityContext
      value:
        capabilities:
          add:
          - NET_ADMIN
          drop:
          - ALL
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 2000
        asdf: 123
- it: should include extra volumeMounts in the cron container
  template: deployment-cron.yaml
  set:
    cron:
      extraVolumeMounts:
      - name: extra-volume
        mountPath: /extra/path
  asserts:
  - equal:
      path: spec.template.spec.containers[0].volumeMounts
      value:
      - name: extra-volume
        mountPath: /extra/path
      - mountPath: /tower.yml
        name: config-volume
        subPath: tower.yml
      - mountPath: /var/cache/tower/
        name: plugin-volume
      - mountPath: /.nextflow/
        name: plugin-volume
      - mountPath: /?/.nextflow/
        name: plugin-volume
- it: should use custom image for the cron deployment
  template: deployment-cron.yaml
  set:
    cron:
      image:
        registry: my-custom-registry.io
        repository: my-custom-repo/my-cron-image
        tag: 2.0.0
        pullPolicy: Always
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-custom-registry.io/my-custom-repo/my-cron-image:2.0.0
  - equal:
      path: spec.template.spec.containers[0].imagePullPolicy
      value: Always
- it: should use custom image digest for the cron deployment
  template: deployment-cron.yaml
  set:
    cron:
      image:
        registry: my-custom-registry.io
        repository: my-custom-repo/my-cron-image
        tag: this-will-be-ignored
        digest: sha256:whatever
        pullPolicy: Always
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-custom-registry.io/my-custom-repo/my-cron-image@sha256:whatever
- it: should use custom image for the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        image:
          registry: my-custom-registry.io
          repository: my-custom-repo/my-migrate-db-image
          tag: 3.0.0
          pullPolicy: Always
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: my-custom-registry.io/my-custom-repo/my-migrate-db-image:3.0.0
  - equal:
      path: spec.template.spec.initContainers[2].imagePullPolicy
      value: Always
- it: should use custom image digest for the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        image:
          registry: my-custom-registry.io
          repository: my-custom-repo/my-migrate-db-image
          tag: this-will-be-ignored
          digest: sha256:migratedbwhatever
          pullPolicy: Always
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: my-custom-registry.io/my-custom-repo/my-migrate-db-image@sha256:migratedbwhatever
  - equal:
      path: spec.template.spec.initContainers[2].imagePullPolicy
      value: Always
- it: should use custom command and args for the cron container
  template: deployment-cron.yaml
  set:
    cron:
      command:
      - /bin/custom-cron-start
      args:
      - --custom-arg1
      - value1
  asserts:
  - equal:
      path: spec.template.spec.containers[0].command
      value:
      - /bin/custom-cron-start
  - equal:
      path: spec.template.spec.containers[0].args
      value:
      - --custom-arg1
      - value1
- it: should use custom command and args for the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        command:
        - /bin/custom-migrate-db
        args:
        - --migrate-arg1
        - value1
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].command
      value:
      - /bin/custom-migrate-db
  - equal:
      path: spec.template.spec.initContainers[2].args
      value:
      - --migrate-arg1
      - value1
- it: should render custom resources for the cron container
  template: deployment-cron.yaml
  set:
    cron:
      resources:
        limits:
          memory: 1Gi
        requests:
          cpu: '1'
          memory: 512Mi
  asserts:
  - equal:
      path: spec.template.spec.containers[0].resources
      value:
        limits:
          memory: 1Gi
        requests:
          cpu: '1'
          memory: 512Mi
- it: should render custom resources for the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        resources:
          limits:
            memory: 1Gi
          requests:
            cpu: '1'
            memory: 512Mi
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].resources
      value:
        limits:
          memory: 1Gi
        requests:
          cpu: '1'
          memory: 512Mi
- it: should disable probes for the cron container
  template: deployment-cron.yaml
  set:
    cron:
      livenessProbe:
        enabled: false
      readinessProbe:
        enabled: false
  asserts:
  - notExists:
      path: spec.template.spec.containers[0].livenessProbe
  - notExists:
      path: spec.template.spec.containers[0].readinessProbe
  - notExists:
      path: spec.template.spec.containers[0].startupProbe
- it: should use custom probe settings for the cron container
  template: deployment-cron.yaml
  set:
    cron:
      livenessProbe:
        initialDelaySeconds: 10
        periodSeconds: 20
      readinessProbe:
        initialDelaySeconds: 15
        periodSeconds: 25
      startupProbe:
        enabled: true
        initialDelaySeconds: 20
        periodSeconds: 30
  asserts:
  - equal:
      path: spec.template.spec.containers[0].startupProbe
      value:
        failureThreshold: 5
        httpGet:
          path: /health
          port: 8082
        initialDelaySeconds: 20
        periodSeconds: 30
        successThreshold: 1
        timeoutSeconds: 3
  - equal:
      path: spec.template.spec.containers[0].livenessProbe
      value:
        failureThreshold: 10
        httpGet:
          path: /health
          port: 8082
        initialDelaySeconds: 10
        periodSeconds: 20
        successThreshold: 1
        timeoutSeconds: 3
  - equal:
      path: spec.template.spec.containers[0].readinessProbe
      value:
        failureThreshold: 5
        httpGet:
          path: /health
          port: 8082
        initialDelaySeconds: 15
        periodSeconds: 25
        successThreshold: 1
        timeoutSeconds: 3
- it: should add image pull secrets to the cron deployment
  template: deployment-cron.yaml
  set:
    cron:
      image:
        pullSecrets:
        - my-custom-pull-secret
  asserts:
  - equal:
      path: spec.template.spec.imagePullSecrets
      value:
      - name: my-custom-pull-secret
- it: should add image pull secrets to the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    cron:
      dbMigrationInitContainer:
        image:
          pullSecrets:
          - my-migrate-db-pull-secret
  asserts:
  - equal:
      path: spec.template.spec.imagePullSecrets
      value:
      - name: my-migrate-db-pull-secret

- it: should use azure-specific image defined in global.azure.images.platformBackend
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: my-azure-registry.azurecr.io
            image: myimage
            tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-azure-registry.azurecr.io/myimage:1.2.3

- it: should use azure-specific image with digest, overriding the tag
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: my-azure-registry.azurecr.io
            image: myimage
            tag: this-will-be-ignored
            digest: sha256:abc123
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-azure-registry.azurecr.io/myimage@sha256:abc123

- it: should fall back to chart appVersion when azure override has no tag
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: my-azure-registry.azurecr.io
            image: myimage
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-azure-registry.azurecr.io/myimage:v9.9.9

- it: should render azure override without registry prefix when registry is not set
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            image: myimage
            tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: myimage:1.2.3

- it: should fall back to default cron.image when azure platformBackend.image is empty
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: my-azure-registry.azurecr.io
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: private/nf-tower-enterprise/backend:v9.9.9

- it: should prefer azure override over custom cron.image when both are set
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: my-azure-registry.azurecr.io
            image: azure-image
            tag: 2.0.0
    cron:
      image:
        registry: custom-registry.io
        repository: custom-repo/custom-image
        tag: 3.0.0
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-azure-registry.azurecr.io/azure-image:2.0.0

- it: should evaluate templates in azure override image fields
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
            image: '{{ printf "my-%s" "image" }}'
            tag: '{{ .Chart.AppVersion }}'
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: my-registry-azurecr.io/my-image:v9.9.9

- it: should use azure-specific image for the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformCronMigrateDB:
            registry: my-azure-registry.azurecr.io
            image: my-migrate-db
            tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: my-azure-registry.azurecr.io/my-migrate-db:1.2.3

- it: should fall back to default migrate-db image when azure platformCronMigrateDB.image is empty
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformCronMigrateDB:
            registry: my-azure-registry.azurecr.io
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: private/nf-tower-enterprise/migrate-db:v9.9.9

- it: should use azure override with digest for the migrate-db initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformCronMigrateDB:
            registry: my-azure-registry.azurecr.io
            image: my-migrate-db
            tag: this-will-be-ignored
            digest: sha256:migrateabc123
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: my-azure-registry.azurecr.io/my-migrate-db@sha256:migrateabc123

- it: should evaluate templates in azure override fields for migrate-db initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformCronMigrateDB:
            registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
            image: '{{ printf "my-%s" "migrate-db" }}'
            tag: '{{ .Chart.AppVersion }}'
  asserts:
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: my-registry-azurecr.io/my-migrate-db:v9.9.9

- it: should allow independent azure overrides for cron and migrate-db images
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          platformBackend:
            registry: azure-registry.azurecr.io
            image: azure-backend
            tag: 1.0.0
          platformCronMigrateDB:
            registry: azure-registry.azurecr.io
            image: azure-migrate-db
            tag: 2.0.0
  asserts:
  - equal:
      path: spec.template.spec.containers[0].image
      value: azure-registry.azurecr.io/azure-backend:1.0.0
  - equal:
      path: spec.template.spec.initContainers[2].image
      value: azure-registry.azurecr.io/azure-migrate-db:2.0.0

- it: should use azure-specific image for the wait-for-MySQL initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          waitForMySQL:
            registry: my-azure-registry.azurecr.io
            image: my-mysql-wait
            tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: my-azure-registry.azurecr.io/my-mysql-wait:1.2.3

- it: should fall back to default wait-for-MySQL image when azure waitForMySQL.image is empty
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          waitForMySQL:
            registry: my-azure-registry.azurecr.io
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: mysql:9

- it: should evaluate templates in azure override fields for wait-for-MySQL initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          waitForMySQL:
            registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
            image: '{{ printf "my-%s" "mysql" }}'
            tag: '{{ .Chart.AppVersion }}'
  asserts:
  - equal:
      path: spec.template.spec.initContainers[0].image
      value: my-registry-azurecr.io/my-mysql:v9.9.9

- it: should use azure-specific image for the wait-for-Redis initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          waitForRedis:
            registry: my-azure-registry.azurecr.io
            image: my-redis-wait
            tag: 1.2.3
  asserts:
  - equal:
      path: spec.template.spec.initContainers[1].image
      value: my-azure-registry.azurecr.io/my-redis-wait:1.2.3

- it: should fall back to default wait-for-Redis image when azure waitForRedis.image is empty
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          waitForRedis:
            registry: my-azure-registry.azurecr.io
  asserts:
  - equal:
      path: spec.template.spec.initContainers[1].image
      value: redis:7

- it: should evaluate templates in azure override fields for wait-for-Redis initContainer
  template: deployment-cron.yaml
  set:
    global:
      azure:
        images:
          waitForRedis:
            registry: '{{ printf "my-registry-%s" "azurecr.io" }}'
            image: '{{ printf "my-%s" "redis" }}'
            tag: '{{ .Chart.AppVersion }}'
  asserts:
  - equal:
      path: spec.template.spec.initContainers[1].image
      value: my-registry-azurecr.io/my-redis:v9.9.9
